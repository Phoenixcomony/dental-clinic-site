<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تم الحجز - عيادة فينكس</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ok:#16a34a; --ok-bg:#ecfdf5;
      --ink:#0f172a; --muted:#64748b; --card:#ffffff; --bg:#f8fafc; --border:#e2e8f0;
      --brand:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Tajawal',system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{max-width:720px; width:100%}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px;
      box-shadow:0 10px 25px rgba(2,8,23,.04);
    }
    .header{
      display:flex; gap:16px; align-items:center; margin-bottom:12px;
    }
    .badge{
      width:48px; height:48px; border-radius:12px; background:var(--ok-bg); display:grid; place-items:center; color:var(--ok); font-size:28px;
      border:1px solid #bbf7d0;
    }
    h1{margin:0;font-size:22px}
    .msg{color:var(--muted); margin-top:4px}
    .grid{
      display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px;
    }
    @media (min-width:640px){ .grid{ grid-template-columns:1fr 1fr; } }
    .row{
      border:1px dashed var(--border); padding:14px 16px; border-radius:12px; background:#fff;
    }
    .row b{display:block; color:#0b1220; margin-bottom:6px}
    .row span{color:var(--muted)}
    .note{white-space:pre-wrap}
    .actions{display:flex; gap:10px; margin-top:18px; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer;
      padding:12px 16px; border-radius:10px; font-weight:600;
    }
    .primary{background:var(--brand); color:#fff}
    .ghost{background:#fff; border:1px solid var(--border); color:#0b1220}
    .tiny{font-size:12px; color:#94a3b8; margin-top:12px}
    .hr{height:1px;background:var(--border);margin:18px 0}
    .hint{background:#f1f5f9;border:1px solid var(--border); color:#0b1220; padding:12px 14px;border-radius:10px;font-size:14px}
    .center{ text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="badge">✓</div>
        <div>
          <h1 id="title">تم تأكيد الحجز</h1>
          <div id="subtitle" class="msg">جارٍ تجهيز تفاصيل الحجز…</div>
        </div>
      </div>

      <div class="grid" id="detailsGrid" hidden>
        <div class="row">
          <b>العيادة</b>
          <span id="clinicTxt">—</span>
        </div>
        <div class="row">
          <b>التاريخ والوقت</b>
          <span id="whenTxt">—</span>
        </div>
        <div class="row">
          <b>الخدمات</b>
          <span id="servicesTxt">—</span>
        </div>
        <div class="row">
          <b>ملاحظة</b>
          <span id="noteTxt" class="note">—</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="hint" id="serverMsg">تم الحجز بنجاح.</div>

      <div class="actions">
        <button class="btn primary" id="homeBtn">العودة للرئيسية</button>
        <button class="btn ghost" id="againBtn">حجز موعد آخر</button>
      </div>

      <div class="tiny">
        إن لم تصلك رسالة واتساب خلال دقائق، بإمكانك التواصل معنا عبر صفحة <a href="contact.html">اتصل بنا</a>.
      </div>
    </div>

    <p class="tiny center" id="diag"></p>
  </div>

  <script>
    // ـــــــــــــــ Helpers ـــــــــــــــ
    const toAscii = s => String(s||'').replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
    const isIso = s => /^\d{4}-\d{2}-\d{2}$/.test(s||'');
    function to12h(t){
      if(!t) return '';
      const [H,M='00']=String(t).split(':'); let h=Number(H); const am=h<12; h=h%12||12;
      return `${h}:${String(M).padStart(2,'0')} ${am?'ص':'م'}`;
    }

    // ـــــــــــــــ اقرا القيم من التخزين ـــــــــــــــ
    const store = (k)=> localStorage.getItem(k) ?? sessionStorage.getItem(k);

    // الرسالة القادمة من الحجز
    const serverMsg = store('booking_result_msg') || 'تم الحجز بنجاح';
    document.getElementById('serverMsg').textContent = serverMsg;

    // تفاصيل الحجز (نحاول عدة مفاتيح شائعة)
    const clinic = store('booking_clinic') || store('selected_clinic') || '';
    const month  = store('booking_month_text') || store('booking_month') || '';
    const date   = store('booking_date') || '';         // بصيغة YYYY-MM-DD إن وُجدت
    const time24 = store('booking_time') || '';         // بصيغة HH:MM
    const services = store('booking_services') || store('selected_services') || '';
    const note   = store('booking_note') || '';

    // تجميع الوقت/التاريخ
    let whenTxt = '—';
    if (date && time24) { whenTxt = `${date} - ${to12h(time24)}`; }
    else if (month && time24) { whenTxt = `${month} - ${to12h(time24)}`; }
    else if (month) { whenTxt = month; }

    // أظهر التفاصيل إن وجد شيء مفيد
    const hasAny =
      (clinic && clinic.trim()) ||
      (whenTxt && whenTxt !== '—') ||
      (services && services.trim()) ||
      (note && note.trim());

    if (hasAny) {
      detailsGrid.hidden = false;
      document.getElementById('clinicTxt').textContent = clinic || '—';
      document.getElementById('whenTxt').textContent   = whenTxt || '—';
      document.getElementById('servicesTxt').textContent = services || '—';
      document.getElementById('noteTxt').textContent     = note || '—';
      document.getElementById('subtitle').textContent = 'سعداء بخدمتكم ✨';
    } else {
      document.getElementById('subtitle').textContent = 'تم الحجز بنجاح.';
    }

    // ـــــــــــــــ إرسال تتبع النجاح للمتركس — يستخدم الحقل clinic فقط ـــــــــــــــ
    (async () => {
      try {
        if (clinic && clinic.trim()) {
          await fetch('/api/track-success', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ clinic })
          });
        }
      } catch (e) {
        // صامت
      }
    })();

    // أزرار
    document.getElementById('homeBtn').onclick = () => location.href = 'index.html';
    document.getElementById('againBtn').onclick = () => location.href = 'appointment.html';

    // تشخيص بسيط مفيد أحيانًا
    (function diag(){
      const d = [];
      if (clinic) d.push('Clinic✓');
      if (month||date) d.push('Month/Date✓');
      if (time24) d.push('Time✓');
      if (services) d.push('Services✓');
      document.getElementById('diag').textContent = d.length ? 'Loaded: ' + d.join(' · ') : '';
    })();

    // (اختياري) لا تفرّغ القيم مباشرة حتى لو رجع الزائر للخلف؛
    // لو حاب تنظف بعد العرض بدقائق:
    // setTimeout(() => {
    //   ['booking_result_msg','booking_clinic','booking_month','booking_month_text','booking_date','booking_time','booking_services','booking_note','selected_clinic','selected_services']
    //     .forEach(k => { localStorage.removeItem(k); sessionStorage.removeItem(k); });
    // }, 60000);
  </script>
</body>
</html>
