<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم | فينكس</title>

  <!-- Google Font -->

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#111111;
      --danger:#b00000;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --shadow-soft:0 6px 18px rgba(0,0,0,.05);
    }

    *{box-sizing:border-box}

    body{
      font-family:'Cairo',Arial,sans-serif;
      background:var(--bg);
      margin:0;
      color:var(--text);
    }

    .wrap{
      max-width:1200px;
      margin:32px auto;
      padding:20px;
    }

    /* ===== Header ===== */
    .header{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px 24px;
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-bottom:20px;
    }

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
    }

    .title{
      font-size:22px;
      font-weight:700;
    }

    .auth-box{
      display:flex;
      align-items:center;
      gap:10px;
      background:#fafafa;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 12px;
    }

    .auth-box span{font-size:14px;color:var(--muted)}

    .auth-box input{
      border:none;
      outline:none;
      background:transparent;
      font-family:inherit;
      padding:6px 8px;
      width:160px;
    }

    /* ===== Tabs ===== */
    .tabs{
      display:flex;
      gap:10px;
      background:#f0f1f3;
      padding:6px;
      border-radius:999px;
      width:fit-content;
    }

    .tabs button{
      border:none;
      background:transparent;
      padding:10px 22px;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      font-size:14px;
      color:var(--muted);
      transition:.25s ease;
    }

    .tabs button.active{
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow-soft);
    }

    /* ===== Panels ===== */
    .panel{
      display:none;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin-top:20px;
      animation:fade .4s ease;
    }

    .panel.active{display:block}

    @keyframes fade{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .panel h3{
      margin:0 0 6px;
      font-size:18px;
    }

    .panel .desc{
      font-size:13px;
      color:var(--muted);
      margin-bottom:16px;
    }

    /* ===== Forms ===== */
    .form-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    input[type="text"], input[type="password"], input[type="file"]{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-family:inherit;
      background:#fafafa;
    }

    /* ===== Buttons ===== */
    .btn{
      padding:10px 16px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-family:inherit;
      transition:.25s ease;
    }

    .btn:hover{transform:translateY(-1px)}

    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .btn.danger{
      background:#ffeded;
      border:1px solid #ffd1d1;
      color:var(--danger);
    }

    /* ===== Grid ===== */
    .row{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(190px,1fr));
      gap:16px;
      margin-top:18px;
    }

    /* ===== Cards ===== */
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow-soft);
      padding:10px;
      position:relative;
      overflow:hidden;
      transition:.3s ease;
    }

    .card:hover{
      transform:translateY(-6px);
      box-shadow:0 18px 45px rgba(0,0,0,.08);
    }

    .card img{
      width:100%;
      height:150px;
      object-fit:contain;
      background:#fafafa;
      border-radius:10px;
    }

    .card .title{
      font-size:14px;
      font-weight:700;
      margin-top:8px;
    }

    .card .sub{
      font-size:12px;
      color:var(--muted);
    }

    .card .danger{
      position:absolute;
      top:8px;
      left:8px;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
    }

    @media(max-width:600px){
      .auth-box{width:100%;justify-content:space-between}
      .tabs{width:100%}
      .tabs button{flex:1}
    }
    .modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-box{
  background:#fff;
  width:420px;
  max-width:92%;
  padding:20px;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.modal-box input,
.modal-box textarea{
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-family:inherit;
}

.modal-actions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
.audit-item{
  padding:10px 12px;
  border-radius:10px;
  background:#fafafa;
  border:1px solid #eee;
  margin-bottom:8px;
  font-size:13px;
}

.audit-item.add{ border-right:4px solid #16a34a; }
.audit-item.edit{ border-right:4px solid #2563eb; }
.audit-item.delete{ border-right:4px solid #dc2626; }

.audit-item .time{
  color:#6b7280;
  font-size:11px;
}
.audit-controls{
  display:flex;
  gap:10px;
  margin-bottom:12px;
  flex-wrap:wrap;
}

.audit-controls input,
.audit-controls select{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-family:inherit;
  background:#fafafa;
}

.audit-table{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.audit-row{
  display:grid;
  grid-template-columns:140px 1fr 120px 160px;
  gap:10px;
  padding:12px;
  border-radius:12px;
  background:#fafafa;
  border:1px solid var(--border);
  font-size:13px;
  align-items:center;
}

.audit-row .user{
  font-weight:700;
}

.audit-row .time{
  font-size:12px;
  color:var(--muted);
}

.audit-row.add{border-right:5px solid #16a34a}
.audit-row.update{border-right:5px solid #2563eb}
.audit-row.delete{border-right:5px solid #dc2626}

.audit-tag{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  text-align:center;
  width:fit-content;
}

.audit-tag.add{background:#dcfce7;color:#166534}
.audit-tag.update{background:#dbeafe;color:#1e40af}
.audit-tag.delete{background:#fee2e2;color:#7f1d1d}

@media(max-width:700px){
  .audit-row{
    grid-template-columns:1fr;
    gap:6px;
  }
}


  </style>

</head>
<body>
  <!-- LOGIN SCREEN -->
<div id="loginScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);width:340px">
    <h3 style="margin-top:0">تسجيل الدخول</h3>

    <input id="loginUser" type="text" placeholder="اسم المستخدم" style="width:100%;margin-bottom:10px">
    <input id="loginPass" type="password" placeholder="كلمة المرور" style="width:100%;margin-bottom:14px">

    <button class="btn primary" style="width:100%" onclick="login()">دخول</button>
  </div>
</div>
<!-- SET PASSWORD SCREEN -->
<div id="setPasswordScreen" style="display:none;min-height:100vh;align-items:center;justify-content:center">
  <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);width:340px">
    <h3 style="margin-top:0">تعيين كلمة المرور</h3>

    <input id="newPass" type="password" placeholder="كلمة المرور الجديدة" style="width:100%;margin-bottom:10px">
    <input id="newPass2" type="password" placeholder="تأكيد كلمة المرور" style="width:100%;margin-bottom:14px">

    <button class="btn primary" style="width:100%" onclick="setPassword()">حفظ</button>
  </div>
</div>


<div class="wrap">


<!-- المحتوى المقفل -->
<div id="adminApp" style="display:none">


  <!-- Header -->

  <div class="header">
    <div class="header-top">
      <div class="title">لوحة التحكم الإدارية – مجمع فينكس الطبي</div>
      <button class="btn" onclick="logout()">تسجيل خروج</button>

      


<div class="tabs">
  <button id="tabB" class="active">البنرات</button>
  <button id="tabP">الباقات</button>
  <button id="tabC">العيادات</button>
  <button id="tabD">الأطباء</button>
  <button id="tabA" style="display:none">إعدادات الحسابات</button>
</div>

  



  </div>

  <!-- البنرات -->

  <section id="panelB" class="panel active">
    <h3>إدارة البنرات</h3>
    <div class="desc">رفع – عرض – حذف البنرات بشكل مباشر</div>


<div class="form-row">
  <input id="bannerFile" type="file" accept="image/*" multiple>
  <button class="btn primary" onclick="addBanner()">حفظ البنرات</button>
</div>

<div id="banners" class="row"></div>


  </section>
<!-- تعديل العيادة -->
<section id="panelEditClinic" class="panel">
  <h3>تعديل العيادة</h3>
  <div class="desc">تعديل بيانات العيادة المختارة</div>

  <div class="form-row">
    <input id="eLabel" type="text" placeholder="اسم العيادة">
    <input id="eValue" type="text" placeholder="قيمة الحجز">
    <input id="eFrom" type="time">
    <input id="eTo" type="time">
  </div>

  <label><input type="checkbox" id="eFriday"> السماح بالجمعة</label>
  <label><input type="checkbox" id="eSaturday"> السماح بالسبت</label>

  <br><br>
  <button class="btn primary" onclick="saveClinicEdit()">حفظ التعديل</button>
  <button class="btn" onclick="backToClinics()">رجوع</button>
</section>

  <!-- الباقات -->

  <section id="panelP" class="panel">
    <h3>إدارة الباقات</h3>
    <div class="desc">إضافة – تعديل – حذف الباقات التسويقية</div>

<div class="form-row">
  <input id="pkgTitle" type="text" placeholder="عنوان الباقة">
  <input id="pkgDesc" type="text" placeholder="وصف مختصر">
  <input id="pkgFile" type="file" accept="image/*">
  <button class="btn primary" onclick="addPackage()">حفظ الباقة</button>
</div>

<div id="packages" class="row"></div>
</section> <!-- نهاية panelP -->

<section id="panelD" class="panel">
  <h3>إدارة الأطباء</h3>
  <div class="desc">إضافة – تعديل – حذف الأطباء</div>

  <div class="form-row">
    <input id="docName" type="text" placeholder="اسم الطبيب">
    <input id="docDesc" type="text" placeholder="نبذة مختصرة">
    <input id="docFile" type="file" accept="image/*">
    <button class="btn primary" onclick="addDoctor()">حفظ الطبيب</button>
  </div>

  <div id="doctors" class="row"></div>
</section>


  </section>
  <!-- العيادات -->
<section id="panelC" class="panel">
  <h3>إدارة العيادات</h3>
  <div class="desc">إضافة – تحديد وقت – حذف العيادات</div>

  <div class="form-row">
    <input id="cLabel" type="text" placeholder="اسم العيادة">
    <input id="cValue" type="text" placeholder="قيمة الحجز (Imdad)">
    <input id="cFrom" type="time">
    <input id="cTo" type="time">
    <button class="btn primary" onclick="addClinic()">حفظ العيادة</button>
    <label style="display:flex;align-items:center;gap:6px;font-size:14px">
  <input type="checkbox" id="cAllowFriday">
  السماح بيوم الجمعة
</label>

<label style="display:flex;align-items:center;gap:6px;font-size:14px">
  <input type="checkbox" id="cAllowSaturday">
  السماح بيوم السبت
</label>

  </div>

  <div id="clinics" class="row"></div>
</section>
<section id="panelA" class="panel">
  <h3>إعدادات الحسابات</h3>
  <div class="desc">إدارة الموظفين وسجل التعديلات</div>
  <h4 style="margin-top:20px">تغيير كلمة المرور</h4>
<div class="form-row">
  <input id="oldPass" type="password" placeholder="كلمة المرور الحالية">
  <input id="newPassChange" type="password" placeholder="كلمة المرور الجديدة">
  <button class="btn primary" onclick="changePassword()">تغيير</button>
</div>


  <h4>إضافة موظف</h4>
  <div class="form-row">
    <input id="staffName" type="text" placeholder="اسم الموظف">
    <input id="staffUser" type="text" placeholder="اسم المستخدم">
    <button class="btn primary" onclick="addStaff()">إضافة</button>
  </div>

  <h4>الموظفون</h4>
  <div id="staffList" class="row"></div>

 <h4 style="margin-top:20px">سجل التعديلات</h4>

<div class="audit-controls">
  <input id="auditSearch" type="text" placeholder="بحث (مستخدم / عملية)">
  <select id="auditFilter">
    <option value="">كل العمليات</option>
    <option value="ADD">إضافة</option>
    <option value="UPDATE">تعديل</option>
    <option value="DELETE">حذف</option>
  </select>
</div>

<div id="auditList" class="audit-table"></div>


</section>



</div>
</div> <!-- نهاية adminApp -->

<script>
const tabB = document.getElementById('tabB');
const tabP = document.getElementById('tabP');
const panelB = document.getElementById('panelB');
const panelP = document.getElementById('panelP');
const tabC = document.getElementById('tabC');
const tabD = document.getElementById('tabD');
const panelD = document.getElementById('panelD');
const panelC = document.getElementById('panelC');
const panelEditClinic = document.getElementById('panelEditClinic');
function staffHeaders(){
  return {
    'x-staff-key': 'AQZa123@'
  };
}


tabB.onclick=()=>{
  tabB.classList.add('active');
  tabP.classList.remove('active');
  tabC.classList.remove('active');

  panelB.classList.add('active');
  panelP.classList.remove('active');
  panelC.classList.remove('active');
}


tabP.onclick=()=>{
  tabP.classList.add('active');
  tabB.classList.remove('active');
  tabC.classList.remove('active');

  panelP.classList.add('active');
  panelB.classList.remove('active');
  panelC.classList.remove('active');
}

tabC.onclick=()=>{
  tabC.classList.add('active');
  tabB.classList.remove('active');
  tabP.classList.remove('active');
  panelC.classList.add('active');
  panelB.classList.remove('active');
  panelP.classList.remove('active');
}
tabD.onclick = () => {
  // ===== TAB A (إعدادات الحسابات) =====
tabA.onclick = () => {
  if (tabA.style.display === 'none') return;

  // إزالة active من كل التابات
  [tabB, tabP, tabC, tabD, tabA].forEach(t =>
    t.classList.remove('active')
  );

  // إخفاء كل الصفحات
  [panelB, panelP, panelC, panelD, panelEditClinic].forEach(p =>
    p.classList.remove('active')
  );

  // تفعيل إعدادات الحسابات
  tabA.classList.add('active');
  panelA.classList.add('active');

  loadStaff();
  loadAudit();
};

  [tabB, tabP, tabC].forEach(t => t.classList.remove('active'));
  [panelB, panelP, panelC, panelEditClinic].forEach(p => p.classList.remove('active'));

  tabD.classList.add('active');
  panelD.classList.add('active');

  loadDoctors();
};






async function loadAll(){
  const b = await fetch('/api/banners').then(r=>r.json());
  const p = await fetch('/api/packages').then(r=>r.json());
  renderBanners(b.banners||[]);
  renderPackages(p.packages||[]);
  loadClinicsAdmin();
}


function renderBanners(list){
  const el = document.getElementById('banners'); el.innerHTML='';
  list.forEach(x=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<img src="${x.src}"><button class="btn danger" onclick="delBanner('${x.id}')">حذف</button>`;
    el.appendChild(c);
  });
}

function renderPackages(list){
  const el = document.getElementById('packages'); el.innerHTML='';
  list.forEach(x=>{
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<img src="${x.img}">
      <div class="title">${x.title}</div>
      <div class="sub">${x.desc||''}</div>
      <button class="btn danger" onclick="delPackage('${x.id}')">حذف</button>`;
    el.appendChild(c);
  });
}

async function addBanner(){
  const files = document.getElementById('bannerFile').files;
  if(!files.length) return alert('اختر صورة أو أكثر');

  const fd = new FormData();
  for (const f of files) fd.append('files', f);

  const r=await fetch('/api/admin/banners',{
  method:'POST',
   
  body: fd
});

  if(!r.ok) return alert('فشل');
  
}

async function delBanner(id){
  if(!confirm('تأكيد الحذف؟')) return;
  await fetch('/api/admin/banners/'+id,{method:'DELETE',headers:staffHeaders()});
  
}

async function addPackage(){
  const t = document.getElementById('pkgTitle').value.trim();
  const d = document.getElementById('pkgDesc').value.trim();
  const f = document.getElementById('pkgFile').files[0];

  if(!t || !f) return alert('العنوان والصورة مطلوبة');

  const fd = new FormData();
  fd.append('file', f);
  fd.append('title', t);
  fd.append('desc', d);

  const r = await fetch('/api/admin/packages',{
    method:'POST',
    
    body: fd
  });

  if(!r.ok) return alert('فشل');
  
}

async function delPackage(id){
  if(!confirm('تأكيد الحذف؟')) return;
  await fetch('/api/admin/packages/'+id,{method:'DELETE',headers:staffHeaders()});
  
}
// ================= CLINICS ADMIN =================
let currentClinicId = null;

async function openClinicEdit(id){
  const r = await fetch('/api/admin/clinics', {
  headers: staffHeaders()
});

;
  const data = await r.json();
  const c = (data.clinics || []).find(x => x.id === id);
  if(!c) return alert('العيادة غير موجودة');

  currentClinicId = id;

  eLabel.value = c.label;
  eValue.value = c.value;
  eFrom.value  = c.from;
  eTo.value    = c.to;
  eFriday.checked   = !!c.allowFriday;
  eSaturday.checked = !!c.allowSaturday;

  panelC.classList.remove('active');
  panelEditClinic.classList.add('active');
}
async function saveClinicEdit(){
  const payload = {
    label: eLabel.value,
    value: eValue.value,
    from:  eFrom.value,
    to:    eTo.value,
    allowFriday: eFriday.checked,
    allowSaturday: eSaturday.checked
  };

  const r = await fetch('/api/admin/clinics/' + currentClinicId, {
    method:'PUT',
    headers:{ ...staffHeaders(), 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  if(!r.ok) return alert('فشل التحديث');

  backToClinics();
  loadClinicsAdmin();
}

function backToClinics(){
  panelEditClinic.classList.remove('active');
  panelC.classList.add('active');
}




async function loadClinicsAdmin(){
  const r = await fetch('/api/admin/clinics', {
    headers: staffHeaders()
  });
  const data = await r.json();
  renderClinics(data.clinics || []);
}


function renderClinics(list){
  const el = document.getElementById('clinics');
  el.innerHTML = '';
  list.forEach(c=>{
    const card = document.createElement('div');
    card.className = 'card';
  card.innerHTML = `
  <div class="title">${c.label}</div>
  <div class="sub">${c.from} – ${c.to}</div>

  <div class="sub" style="margin-top:6px">
    الجمعة:
    <strong style="color:${c.allowFriday ? '✔️' : '❌'}">
      ${c.allowFriday ? 'مسموح' : 'غير مسموح'}
    </strong>
    <br>
    السبت:
    <strong style="color:${c.allowSaturday ? '✔️' : '❌'}">
      ${c.allowSaturday ? 'مسموح' : 'غير مسموح'}
    </strong>
  </div>

 <button class="btn" onclick="openClinicEdit('${c.id}')">تعديل</button>

  <button class="btn danger" onclick="delClinic('${c.id}')">حذف</button>
`;


    el.appendChild(card);
  });
}


async function addClinic(){
  const payload = {
    label: cLabel.value.trim(),
    value: cValue.value.trim(),
    from:  cFrom.value,
    to:    cTo.value,
    allowFriday: document.getElementById('cAllowFriday').checked,
    allowSaturday: document.getElementById('cAllowSaturday').checked
  };

  const r = await fetch('/api/admin/clinics',{
    method:'POST',
    headers:{ ...staffHeaders(),'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  if(!r.ok){
    alert('فشل إضافة العيادة');
    return;
  }

  // ✅ رسالة نجاح
  alert('تمت إضافة العيادة بنجاح');

  // ✅ تصفير الحقول
  cLabel.value = '';
  cValue.value = '';
  cFrom.value  = '';
  cTo.value    = '';
  document.getElementById('cAllowFriday').checked = false;
  document.getElementById('cAllowSaturday').checked = false;

  // ✅ إعادة تحميل القائمة
  loadClinicsAdmin();
}




async function delClinic(id){
  if(!confirm('تأكيد الحذف؟')) return;
 await fetch('/api/admin/clinics/'+id,{
  method:'DELETE',
  headers: staffHeaders()
});

  loadClinicsAdmin();
}
let currentDoctorId = null;
let doctorsCache = [];
async function loadDoctors(){
  const r = await fetch('/api/admin/doctors',{headers:staffHeaders()});
  const d = await r.json();
  doctorsCache = d.doctors || [];
  renderDoctors(doctorsCache);
}

function renderDoctors(list){
  const el = document.getElementById('doctors');
  el.innerHTML='';
  list.forEach(x=>{
    el.innerHTML += `
      <div class="card">
        <img src="${x.img}">
        <div class="title">${x.name}</div>
        <div class="sub">${x.desc||''}</div>

        <button class="btn" onclick="openEditDoctor('${x.id}')">تعديل</button>
        <button class="btn danger" onclick="delDoctor('${x.id}')">حذف</button>
      </div>
    `;
  });
}



function openEditDoctor(id){
  const doc = doctorsCache.find(x=>x.id===id);
  if(!doc) return;

  currentDoctorId = id;
  editDocName.value = doc.name;
  editDocDesc.value = doc.desc || '';

  document.getElementById('editDoctorModal').style.display = 'flex';
}

function closeEditDoctor(){
  document.getElementById('editDoctorModal').style.display = 'none';
}

async function saveDoctorEdit(){
  const fd = new FormData();
  fd.append('name', editDocName.value);
  fd.append('desc', editDocDesc.value);

  if(editDocFile.files[0]){
    fd.append('file', editDocFile.files[0]);
  }

  await fetch('/api/admin/doctors/'+currentDoctorId,{
  method:'PUT',
  headers: staffHeaders(),
  body: fd
});


  closeEditDoctor();
  loadDoctors();
}


</script>
<script>


async function addDoctor(){
  const fd = new FormData();
  fd.append('file', docFile.files[0]);
  fd.append('name', docName.value);
  fd.append('desc', docDesc.value);

  await fetch('/api/admin/doctors',{
    method:'POST',
    headers:staffHeaders(),
    body:fd
  });
  loadDoctors();
}

async function delDoctor(id){
  await fetch('/api/admin/doctors/'+id,{
    method:'DELETE',
    headers:staffHeaders()
  });
  loadDoctors();
}



</script>
<div id="editDoctorModal" class="modal">
  <div class="modal-box">
    <h3>تعديل بيانات الطبيب</h3>

    <input id="editDocName" type="text" placeholder="اسم الطبيب">
    <textarea id="editDocDesc" placeholder="نبذة الطبيب"></textarea>
    <input id="editDocFile" type="file" accept="image/*">

    <div class="modal-actions">
      <button class="btn primary" onclick="saveDoctorEdit()">حفظ</button>
      <button class="btn" onclick="closeEditDoctor()">إلغاء</button>
    </div>
  </div>
</div>
<script>
// ===== LOGIN =====
async function login(){
  async function setPassword(){
  const p1 = newPass.value;
  const p2 = newPass2.value;

  if(p1 !== p2) return alert('غير متطابقة');

  const r = await fetch('/api/auth/set-password',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ newPassword:p1 })
  });

  if(!r.ok) return alert('فشل');

  setPasswordScreen.style.display='none';
  adminApp.style.display='block';
  loadAll();
}

  const username = loginUser.value.trim();
  const password = loginPass.value;

  const r = await fetch('/api/auth/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username, password })
  });

  const j = await r.json();
  if(!j.ok) return alert('فشل تسجيل الدخول');

  loginScreen.style.display='none';

  // موظف جديد → تعيين كلمة مرور
  if(j.mustSetPassword){
    setPasswordScreen.style.display='flex';
    return;
  }

  adminApp.style.display='block';
  loadAll();

  if(j.role === 'admin'){
    tabA.style.display='inline-block';
  }
}


// ===== SET PASSWORD =====
async function setPassword(){
  const p1 = newPass.value;
  const p2 = newPass2.value;

  if(p1 !== p2) return alert('غير متطابقة');

  const r = await fetch('/api/auth/set-password',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ newPassword:p1 })
  });

  if(!r.ok) return alert('فشل');

  setPasswordScreen.style.display='none';
  adminApp.style.display='block';
  loadAll();
}

// ===== LOGOUT =====
async function logout(){
  await fetch('/api/auth/logout', { method:'POST' });

  adminApp.style.display='none';
  setPasswordScreen.style.display='none';
  loginScreen.style.display='flex';
}
tabA.onclick = () => {
  // حماية إضافية
  if (tabA.style.display === 'none') return;

  // إخفاء كل الأقسام
  [panelB, panelP, panelC, panelD].forEach(p => p.classList.remove('active'));

  // إظهار إعدادات الحسابات
  panelA.classList.add('active');

  loadStaff();
  loadAudit();
};
async function changePassword(){
  const oldP = oldPass.value;
  const newP = newPassChange.value;

  if(!oldP || !newP) return alert('أكمل الحقول');

  const r = await fetch('/api/auth/change-password',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      oldPassword: oldP,
      newPassword: newP
    })
  });

  if(!r.ok) return alert('فشل تغيير كلمة المرور');

  alert('تم تغيير كلمة المرور');
  oldPass.value = '';
  newPassChange.value = '';
}

let auditCache = [];

async function loadAudit(){
  const r = await fetch('/api/admin/audit');
  const j = await r.json();
  auditCache = j.logs || [];
  renderAudit(auditCache);
}

function renderAudit(list){
  const q = auditSearch.value.toLowerCase();
  const f = auditFilter.value;

  auditList.innerHTML = '';

  list
    .filter(l=>{
      const hit =
        l.by.toLowerCase().includes(q) ||
        l.action.toLowerCase().includes(q);

      const ok = !f || l.action === f;
      return hit && ok;
    })
    .forEach(l=>{
      const type = l.action.toLowerCase();

      auditList.innerHTML += `
        <div class="audit-row ${type}">
          <div class="user">${l.by}</div>
          <div>${l.action}</div>
          <div class="audit-tag ${type}">${l.action}</div>
          <div class="time">${l.time}</div>
        </div>
      `;
    });


auditSearch.oninput = ()=>renderAudit(auditCache);
auditFilter.onchange = ()=>renderAudit(auditCache);

  // ===== TAB A =====
tabA.onclick = ()=>{
  if(tabA.style.display === 'none') return;

  [panelB,panelP,panelC,panelD].forEach(p=>p.classList.remove('active'));
  panelA.classList.add('active');

  loadStaff();
  loadAudit();
};

// ===== CHANGE PASSWORD =====
async function changePassword(){
  const oldP = oldPass.value;
  const newP = newPassChange.value;

  if(!oldP || !newP) return alert('أكمل الحقول');

  const r = await fetch('/api/auth/change-password',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ oldPassword: oldP, newPassword: newP })
  });

  if(!r.ok) return alert('فشل تغيير كلمة المرور');

  alert('تم تغيير كلمة المرور');
  oldPass.value='';
  newPassChange.value='';
}

}
</script>

<script>
async function addStaff(){
  const name = document.getElementById('staffName').value.trim();
  const username = document.getElementById('staffUser').value.trim();

  if(!name || !username){
    alert('أدخل اسم الموظف واسم المستخدم');
    return;
  }

  const r = await fetch('/api/admin/staff', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    credentials: 'include',
    body: JSON.stringify({ name, username })
  });

  if(!r.ok){
    alert('فشل إضافة الموظف');
    return;
  }

  alert('تمت إضافة الموظف');
  staffName.value = '';
  staffUser.value = '';
  loadStaff();
}

async function loadStaff(){
  const r = await fetch('/api/admin/staff', {
    credentials:'include'
  });
  const j = await r.json();

  staffList.innerHTML = '';
  (j.staff || []).forEach(s=>{
    staffList.innerHTML += `
      <div class="card">
        <div class="title">${s.name}</div>
        <div class="sub">@${s.username}</div>

        <button class="btn danger" onclick="deleteStaff('${s.id}')">
          حذف
        </button>
      </div>
    `;
  });
}
async function deleteStaff(id){
  if(!confirm('تأكيد حذف الموظف؟')) return;

  const r = await fetch('/api/admin/staff/' + id, {
    method:'DELETE',
    credentials:'include'
  });

  if(!r.ok){
    alert('فشل حذف الموظف');
    return;
  }

  loadStaff();
}

</script>

</body>
</html>
