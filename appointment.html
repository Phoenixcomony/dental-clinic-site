<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حجز موعد | مجمع فينكس الطبي</title>
  <meta name="description" content="سجّل دخولك بالاسم الثلاثي والجوال مع تحقق واتساب، ثم احجز موعدك.">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --gold-main:#e2be6d;
      --gold-shadow:0 4px 32px 0 #e2be6d26, 0 1.5px 6px #ffdfa215;
      --gold-light:#fff8e6;
      --gold-gradient:linear-gradient(90deg,#e8ca7c 10%, #fff8e6 100%);
    }
    body{ font-family:'Cairo', Tahoma, Arial, sans-serif; margin:0; min-height:100vh; display:flex; flex-direction:column; background:#fffdfa; }
    .wrap{ max-width:540px; margin:26px auto; background:#fff; border:1px solid #e8ca7c80; border-radius:18px; box-shadow:var(--gold-shadow); padding:18px; }
    .title{ display:flex; align-items:center; gap:10px; justify-content:center; font-weight:800; color:#a67c0e; margin:6px 0 14px; }
    label{ display:block; font-weight:700; color:#b18836; margin:.5rem 0 .3rem; }
    input, select{ width:100%; padding:12px 11px; border-radius:14px; border:1.4px solid #e2be6d99; background:#fffdfa; font-size:1rem; }
    input:focus, select:focus{ border:1.7px solid #e2be6d; background:#fff9e0; outline:none; }
    .btn{ width:100%; padding:13px 0; border:none; border-radius:16px; font-weight:800; background:var(--gold-gradient); color:#6b4b00; cursor:pointer; box-shadow:0 6px 16px #e2be6d33; transition:.2s ease; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:#7a6d4e; font-size:.95rem; text-align:center; min-height:22px; margin-top:8px; }
    .row{ display:flex; gap:8px; } .row > *{ flex:1; }
    footer{ margin-top:auto; text-align:center; padding:10px; color:#8c6d1c; font-weight:700; background:rgba(255,255,255,0.219); border-top:1.5px solid #eee; letter-spacing:.6px; box-shadow:0 -2px 12px #e2be6d54; }

    /* خلفية ضبابية عامة */
    .blur-bg-appointment{
      position: fixed; inset: 0;
      background: url('images/حجز الموعد.png') center/cover no-repeat;
      filter: blur(16px) brightness(0.97);
      opacity: 1; z-index: 0; pointer-events: none;
    }
    body > *:not(.blur-bg-appointment){ position: relative; z-index: 1; }

    /* ====== الهيدر المتجاوب ====== */
    header{
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.7);
      border-bottom: 1px solid #f1e4c5;
      box-shadow: 0 6px 24px #e2be6d26;
      position: sticky; top: 0; z-index: 5;
    }
    .container.header-flex{
      display:flex; justify-content:space-between; align-items:center;
      max-width:1200px; margin:0 auto; padding:10px 16px;
    }
    .logo-container{ display:flex; align-items:center; gap:10px; }
    .logo-img{ height:46px; margin-left:9px; }

    /* أجبر القوائم أفقية حتى على الجوال */
    header nav ul{
      list-style:none; display:flex !important; flex-direction:row !important;
      align-items:center; gap:18px; margin:0; padding:0; background:transparent;
      flex-wrap:wrap; justify-content:center;
    }
    header nav ul li{ display:flex; align-items:center; margin:0; padding:0; }
    header nav ul li a{
      color:#181818; text-decoration:none; padding:7px 14px; font-weight:700;
      border-radius:999px; font-size:1.05em; transition:.25s; background:transparent;
      display:inline-block; white-space:nowrap;
    }
    header nav ul li a.active, header nav ul li a:hover{
      background-color:#fffbe7; color:#a8861c; box-shadow:0 2px 10px #e2be6d23;
    }

    /* أيقونات التواصل بالعرض */
    .social-icons{
      display:flex !important; align-items:center; gap:8px; margin-inline-start:8px;
      flex-wrap:nowrap;
    }
    .social-icons .social-icon{
      font-size:1.1em; display:inline-flex; align-items:center; justify-content:center;
      width:32px; height:32px; border-radius:50%;
      background:#fff3ce; color:#b89023; text-decoration:none;
      border:1.2px solid #f9e9c8; box-shadow:0 1px 6px #e2be6d26; transition:.2s;
    }
    .social-icons .social-icon:hover{ background:#fffbe7; color:#84610f; transform: translateY(-1px); }

    @media (max-width: 900px){
      .container.header-flex{ flex-direction:column; gap:8px; padding:8px 12px; }
      .logo-img{ height:42px; }
      header nav ul{ gap:12px; }
    }
    @media (max-width: 650px){
      header nav ul{ gap:10px; }
      header nav ul li a{ font-size:.98em; padding:6px 10px; border-radius:12px; }
      .social-icons{ gap:6px; }
      .social-icons .social-icon{ width:30px; height:30px; font-size:1em; }
      .wrap{ margin:16px auto; border-radius:16px; }
    }

    /* ====== شاشة التحميل (انتظار) ====== */
    .screen-loader{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(3px);
      z-index: 9999;
      transition: opacity .2s ease;
    }
    .screen-loader.show{ display:flex; }
    .spinner{
      width: 70px; height: 70px; border-radius: 50%;
      border: 4px solid #e9d9ac; border-top-color: var(--gold-main);
      animation: spin 0.9s linear infinite;
      box-shadow: 0 8px 28px #e2be6d55;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    /* ===== زر "عرض ساعات العمل" يبقى كما هو ===== */
    .btn-hours{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:14px; border:none;
      font-weight:800; cursor:pointer;
      background: linear-gradient(135deg,#e53935,#d32f2f); color:#fff;
      box-shadow: 0 6px 16px rgba(229,57,53,.45);
      animation: breathe 1.8s ease-in-out infinite;
    }
    .btn-hours i{ font-size:1.05em; }
    @keyframes breathe{
      0%{ transform:scale(1); box-shadow:0 6px 16px rgba(229,57,53,.45); }
      50%{ transform:scale(1.045); box-shadow:0 12px 28px rgba(229,57,53,.6); }
      100%{ transform:scale(1); box-shadow:0 6px 16px rgba(229,57,53,.45); }
    }

    /* ===== المودال الذهبي ===== */
    .hours-modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55); z-index:9999;
    }
    .hours-modal.show{ display:flex; }
    .hours-modal .panel{
      width:min(920px, 92vw); max-height:85vh; overflow:auto;
      background:#fffbe9; border:1px solid #f1e4c5; border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:16px 14px 18px;
      animation: hm-pop .18s ease-out;
    }
    @keyframes hm-pop{ from{ opacity:0; transform:translateY(-10px) scale(.98);} to{ opacity:1; transform:none; } }
    .hours-modal .panel-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
    .hours-modal .panel-title{
      margin:0; color:#e38102; font-weight:800; font-size:1.12rem;
      display:flex; align-items:center; gap:8px;
    }
    .hours-modal .close-btn{
      border:none; background:#fff; color:#bb7d0a; font-size:1.2rem; width:36px; height:36px; border-radius:10px;
      box-shadow:0 2px 8px #e2be6d2e; cursor:pointer;
    }
    .hours-table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
    .hours-table th, .hours-table td{ border:1px solid #eee2bf; padding:10px; text-align:center; }
    .hours-table th{ background:#e38102; color:#fff; }

    /* ===== أزرار زجاجية محلياً فقط في هذه الصفحة ===== */
    .btn-glass{
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(230, 198, 120, 0.52);
      color:#5b4306;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .btn-glass:hover{ background: rgba(255,255,255,0.3); transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.12);}
    .btn-glass:active{ transform: translateY(0); }

    /* ملاحظة الجلدية والتجميل */
    .clinic-note{
      display:none;
      margin:8px 0 0;
      color:#7a5d16;
      background:#fff9e8;
      border:1px dashed #e8ca7c;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      text-align:right;
    }
  </style>
</head>
<body>

  <div class="blur-bg-appointment" aria-hidden="true"></div>

  <!-- شاشة التحميل -->
  <div id="screenLoader" class="screen-loader" aria-live="polite" aria-busy="true">
    <div class="spinner" role="status" aria-label="جاري التحميل"></div>
  </div>

  <header>
    <div class="container header-flex">
      <div class="logo-container">
        <img src="images/logo phoenix-Photoroom.png" alt="شعار مجمع فينكس الطبي" class="logo-img" loading="eager" decoding="async">
      </div>
      <nav aria-label="التنقل الرئيسي">
        <ul>
          <li><a href="index.html">الرئيسية</a></li>
          <li><a href="about.html">من نحن</a></li>
          <li><a href="services.html">الخدمات</a></li>
          <li><a href="appointment.html" class="active" aria-current="page">احجز موعد</a></li>
          <li><a href="contact.html">اتصل بنا</a></li>
          <li>
            <div class="social-icons">
              <a href="https://wa.me/966531422555" target="_blank" rel="noopener" title="واتساب" class="social-icon" aria-label="واتساب"><i class="fab fa-whatsapp"></i></a>
              <a href="https://www.instagram.com/phoenix.shq/" target="_blank" rel="noopener" title="إنستقرام" class="social-icon" aria-label="إنستقرام"><i class="fab fa-instagram"></i></a>
              <a href="https://www.snapchat.com/add/phoenix.shq?share_id=VOXDQhmXrWw&locale=ar-AE" target="_blank" rel="noopener" title="سناب شات" class="social-icon" aria-label="سناب شات"><i class="fab fa-snapchat-ghost"></i></a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- تسجيل الدخول -->
  <section id="loginSection" class="wrap">
    <div class="title"><i class="fa fa-user-check"></i> تسجيل الدخول</div>

    <label for="fullname">الاسم الثلاثي</label>
    <input id="fullname" type="text" placeholder="مثال: محمد أحمد مصطفى" autocomplete="name">

    <label for="mobile">رقم الجوال</label>
    <input id="mobile" type="text" placeholder="05xxxxxxxx" autocomplete="tel" inputmode="numeric" maxlength="10">

    <label for="otp">رمز التحقق (واتساب)</label>
    <input id="otp" type="text" placeholder="6 أرقام" inputmode="numeric" maxlength="6">

    <div class="row" style="margin-top:8px;">
      <button id="sendOtp" class="btn btn-glass" type="button">إرسال كود واتساب</button>
      <button id="loginBtn" class="btn btn-glass" type="button" disabled>تسجيل الدخول</button>
    </div>

    <div id="loginMsg" class="muted"></div>

    <p class="muted" style="margin-top:10px;">
      لا تملك ملفًا؟
      <button class="btn btn-glass" id="openNewFileBtn" type="button" style="padding:9px 12px;width:auto;">افتح ملف جديد</button>
    </p>
  </section>

  <!-- الحجز -->
  <section id="bookingSection" class="wrap" style="display:none;">
    <div class="title"><i class="fa-solid fa-calendar-check"></i> الحجز</div>

    <!-- زر الساعات: تحت "الحجز" وفوق اختيار العيادة -->
    <div style="display:flex; justify-content:center; margin:6px 0 12px;">
      <button id="openHoursModal" type="button" class="btn-hours">
        <i class="fa-solid fa-clock"></i> عرض ساعات العمل
      </button>
    </div>

    <label for="clinic">اختر العيادة</label>
    <select id="clinic">
      <option value="">اختر العيادة</option>
      <option value="عيادة اسنان 5**الفترة الاولى">عيادة اسنان 5 الفترة الصباحية</option>
      <option value="عيادة اسنان 5**الفترة الثانية">عيادة اسنان 5 الفترة المسائية</option>
      <option value="عيادة الاسنان 1**الفترة الاولى">عيادة الاسنان 1 الفترة الصباحية</option>
      <option value="عيادة الاسنان 1**الفترة الثانية">عيادة الاسنان 1 الفترة المسائية</option>
      <option value="عيادة الاسنان 2**الفترة الاولى">عيادة الاسنان 2 الفترة الصباحية</option>
      <option value="عيادة الاسنان 2**الفترة الثانية">عيادة الاسنان 2 الفترة المسائية</option>
      <option value="عيادة الاسنان 3**الفترة الاولى">عيادة الاسنان 3 الفترة الصباحية</option>
      <option value="عيادة الاسنان 3**الفترة الثانية">عيادة الاسنان 3 الفترة المسائية</option>
      <option value="عيادة الاسنان 4**الفترة الاولى">عيادة الاسنان 4 الفترة الصباحية</option>
      <option value="عيادة الاسنان 4**الفترة الثانية">عيادة الاسنان 4 الفترة المسائية</option>
      <option value="عيادة الجلدية والتجميل**الفترة الاولى">عيادة الجلدية والتجميل الفترة الصباحية</option>
      <option value="عيادة الجلدية والتجميل**الفترة الثانية">عيادة الجلدية والتجميل الفترة المسائية</option>
      <option value="عيادة تنظيف البشرة**الفترة الاولى">عيادة تنظيف البشرة الفترة الصباحية</option>
      <option value="عيادة تنظيف البشرة**الفترة الثانية">عيادة تنظيف البشرة الفترة المسائية</option>
      <option value="النساء و الولادة**الفترة الاولى">النساء و الولادة الفترة الصباحية</option>
      <option value="النساء و الولادة**الفترة الثانية">النساء و الولادة الفترة المسائية</option>
    </select>
    <div id="dermNote" class="clinic-note">
      تتضمن الخدمة تقشير وجه نصف ساعة + تقشير حواجب نصف ساعة + تنظيف البشرة نصف ساعة — المدة ساعة
    </div>
    
    <label for="month" style="margin-top:10px;">اختر الشهر</label>
    <select id="month">
      <option value="">اختر الشهر</option>
      <option value="8">أغسطس</option>
      <option value="9">سبتمبر</option>
      <option value="10">أكتوبر</option>
      <option value="11">نوفمبر</option>
      <option value="12">ديسمبر</option>
    </select>

    <button id="fetchBtn" class="btn btn-glass" style="margin-top:10px;">عرض المواعيد</button>

    <label for="time" style="margin-top:14px;">اختر الوقت</label>
    <select id="time" disabled>
      <option value="">يرجى البحث أولاً</option>
    </select>

    <button id="goConfirm" class="btn btn-glass" style="margin-top:12px;" disabled>متابعة لتأكيد الحجز</button>

    <div id="bkMsg" class="muted"></div>
  </section>

  <footer>جميع الحقوق محفوظة © مجمع فينكس الطبي 2025</footer>

  <!-- ===== نافذة ساعات العمل (Modal) ===== -->
  <div id="hoursModal" class="hours-modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="hmTitle">
      <div class="panel-header">
        <h3 id="hmTitle" class="panel-title"><i class="fa-solid fa-clock"></i> ساعات العمل</h3>
        <button id="closeHoursModal" class="close-btn" aria-label="إغلاق"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="hours-table-wrap">
        <table class="hours-table">
          <thead>
            <tr>
              <th>القسم / الطبيب</th>
              <th>الأيام</th>
              <th>الفترة الصباحية</th>
              <th>الفترة المسائية</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>عيادة الأسنان 1 (د. عبير)</td>
              <td>السبت - الخميس</td>
              <td>9:00 ص – 12:00 م</td>
              <td>4:00 م – 9:00 م</td>
            </tr>
            <tr>
              <td>عيادة الأسنان 2 (د. ريان)</td>
              <td>السبت - الخميس</td>
              <td>8:00 ص – 11:00 ص</td>
              <td>4:00 م – 9:00 م</td>
            </tr>
            <tr>
              <td>عيادة الأسنان 3 (د. معاذ)</td>
              <td>السبت - الخميس</td>
              <td>12:00 م – 8:00 م</td>
              <td>-</td>
            </tr>
            <tr>
              <td>عيادة الأسنان 4 (د. رونالدو)</td>
              <td>السبت - الخميس</td>
              <td>2:00 م – 10:00 م</td>
              <td>-</td>
            </tr>
            <tr>
              <td>عيادة الجلدية والتجميل (د. ولاء)</td>
              <td>الأحد - الخميس</td>
              <td>-</td>
              <td>3:30 م – 10:30 م</td>
            </tr>
            <tr>
              <td>التشقير وتنظيف البشرة (أخصائية هدى)</td>
              <td>السبت - الخميس</td>
              <td>-</td>
              <td>2:00 م – 10:00 م</td>
            </tr>
            <tr>
              <td>عيادة الطب العام والطوارئ (د. هنادي)</td>
              <td>السبت - الخميس</td>
              <td>10:00 ص – 12:00 م</td>
              <td>4:00 م – 10:00 م</td>
            </tr>
            <tr>
              <td>عيادة النساء والولادة (د. حسناء)</td>
              <td>السبت - الخميس</td>
              <td>10:00 ص – 12:00 م</td>
              <td>4:00 م – 10:00 م</td>
            </tr>
            <tr>
              <td>   عيادة الليزر (نساء) 1 </td>
              <td>السبت - الخميس</td>
              <td>8:00 ص – 11:00 م</td>
              <td>-</td>
            </tr>
            <tr>
              <td>  عيادة الليزر (نساء) 2 </td>
              <td>السبت - الخميس</td>
              <td>8:00 ص – 11:00 م</td>
              <td>-</td>
            </tr>
            <tr>
              <td>  عيادة الليزر (رجال)  </td>
              <td>السبت - الخميس</td>
              <td>9:00 ص – 2:00 م</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="4" style="background:#fffbe9;font-weight:bold;color:#bb7d0a;">
                يوم الجمعة: طبيب أسنان مناوب (غالبًا د. معاذ)، عيادات الليزر مفتوحة، التشقير وتنظيف البشرة (حسب التوفر) الدوام 2:00 م – 10:00 م حسب العيادة.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- ===== /نافذة ساعات العمل ===== -->

<script>
  // Helpers
  const isTriple = (v)=> (v||'').trim().split(/\s+/).filter(Boolean).length===3;
  const isSaudi05 = (v)=> /^05\d{8}$/.test((v||'').replace(/\D/g,''));

  // Elemente
  const sendOtpBtn = document.getElementById('sendOtp');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const fullname = document.getElementById('fullname');
  const mobile = document.getElementById('mobile');
  const otpInput = document.getElementById('otp');
  const screenLoader = document.getElementById('screenLoader');

  // شاشة الانتظار
  const showLoader = (on)=> {
    if(on){ screenLoader.classList.add('show'); document.body.style.pointerEvents='none'; }
    else { screenLoader.classList.remove('show'); document.body.style.pointerEvents='auto'; }
  };

  // OTP 60s cooldown
  let otpCooldown = 0, otpTimer = null;

  function updateLoginBtn(){
    const ok = isTriple(fullname.value) && isSaudi05(mobile.value) && /^\d{6}$/.test(otpInput.value||'');
    loginBtn.disabled = !ok;
    if (!ok) loginMsg.textContent = 'أدخل الاسم الثلاثي، رقم 05xxxxxxxx، وكود 6 أرقام.';
    else loginMsg.textContent = '';
  }
  ['input','change','keyup'].forEach(ev=>{
    fullname.addEventListener(ev, updateLoginBtn);
    mobile.addEventListener(ev, updateLoginBtn);
    otpInput.addEventListener(ev, updateLoginBtn);
  });
  updateLoginBtn();

  function startOtpTimer(){
    otpCooldown = 60;
    sendOtpBtn.disabled = true;
    const tick = ()=>{
      if(otpCooldown <= 0){
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'إرسال كود واتساب';
        clearInterval(otpTimer); otpTimer=null;
        return;
      }
      sendOtpBtn.textContent = `أعد الإرسال خلال ${otpCooldown--}ث`;
    };
    tick();
    otpTimer = setInterval(tick, 1000);
  }

  // إرسال OTP مع شاشة انتظار
  sendOtpBtn.addEventListener('click', async ()=>{
    const phone = mobile.value.trim();
    if(!isSaudi05(phone)){ loginMsg.textContent = 'الرقم بصيغة 05xxxxxxxx'; return; }
    if(otpCooldown>0) return;
    loginMsg.textContent = 'جاري إرسال الكود...';
    showLoader(true);
    try{
      const r = await fetch('/send-otp', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone })
      });
      const data = await r.json();
      loginMsg.textContent = data.success ? 'تم إرسال الكود على الواتساب' : (data.message || 'تعذر الإرسال');
      if(data.success) startOtpTimer();
    }catch{
      loginMsg.textContent = 'تعذر الاتصال بالخادم';
    }finally{
      showLoader(false);
    }
  });

  // فتح ملف جديد
  document.getElementById('openNewFileBtn').addEventListener('click', ()=>{
    if (isTriple(fullname.value)) localStorage.setItem('auth_name', fullname.value.trim());
    if (isSaudi05(mobile.value))  localStorage.setItem('auth_phone', mobile.value.trim());
    window.location.href = 'new-file.html';
  });

  // تسجيل الدخول مع شاشة انتظار
  loginBtn.addEventListener('click', async ()=>{
    loginBtn.disabled = true; sendOtpBtn.disabled = true;
    loginMsg.textContent = 'جارِ التحقق...';
    const payload = {
      name: fullname.value.trim(),
      phone: mobile.value.trim(),
      otp: otpInput.value.trim()
    };
    showLoader(true);
    try{
      const r = await fetch('/api/login', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();

      if(!data.success){
        loginMsg.textContent = data.message || 'لا تملك ملفًا لدينا. انقر (افتح ملف جديد).';
        loginBtn.disabled = false; sendOtpBtn.disabled = false;
        return;
      }

      // يوجد ملف
      localStorage.setItem('auth_name', data.fullName || payload.name);
      localStorage.setItem('auth_phone', payload.phone);
      localStorage.setItem('auth_fileId', data.fileId || '');

      if (data.hasIdentity === false) {
        loginMsg.textContent = 'نحتاج استكمال الهوية قبل الحجز...';
        setTimeout(()=>{ window.location.href = 'identity.html'; }, 500);
        return;
      }

      // لديه هوية — أظهر الحجز
      loginMsg.textContent = '';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('bookingSection').style.display = '';
    }catch(e){
      loginMsg.textContent = 'تعذّر التحقق حاليًا. حاول لاحقًا.';
      loginBtn.disabled = false; sendOtpBtn.disabled = false;
    }finally{
      showLoader(false);
    }
  });

  // ===== الحجز =====
  const fetchBtn = document.getElementById('fetchBtn');
  const timeSel  = document.getElementById('time');
  const goConfirm = document.getElementById('goConfirm');
  const bkMsg = document.getElementById('bkMsg');
  const clinicSel = document.getElementById('clinic');
  const monthSel  = document.getElementById('month');
  const dermNote  = document.getElementById('dermNote');

  // إظهار ملاحظة الجلدية والتجميل تلقائيًا
  clinicSel.addEventListener('change', ()=>{
    const v = clinicSel.value || '';
    if (v.startsWith('عيادة الجلدية والتجميل')) dermNote.style.display = 'block';
    else dermNote.style.display = 'none';
  });

  fetchBtn.addEventListener('click', async () => {
    const clinic = clinicSel.value;
    const month  = monthSel.value;

    bkMsg.textContent = '';
    timeSel.disabled = true;
    goConfirm.disabled = true;
    timeSel.innerHTML = `<option>...جاري جلب الأوقات...</option>`;

    if (!clinic || !month) {
      timeSel.innerHTML = `<option value="">يرجى اختيار العيادة والشهر</option>`;
      return;
    }

    // قفل الحقول + منع النقرات + إظهار اللودر
    fetchBtn.disabled = true;
    clinicSel.disabled = true;
    monthSel.disabled = true;
    showLoader(true);

    try {
      const r = await fetch('/api/times', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ clinic, month })
      });
      const data = await r.json();
      if (data.times && data.times.length) {
        timeSel.innerHTML = data.times.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
        timeSel.disabled = false;
        goConfirm.disabled = false;
      } else {
        timeSel.innerHTML = `<option value="">لا توجد أوقات متاحة</option>`;
        bkMsg.textContent = 'لا توجد أوقات متاحة حالياً.';
      }
    } catch {
      timeSel.innerHTML = `<option value="">تعذر جلب الأوقات</option>`;
      bkMsg.textContent = 'تعذر جلب الأوقات. حاول لاحقاً.';
    } finally {
      // فتح الحقول من جديد بعد ظهور النتيجة
      fetchBtn.disabled = false;
      clinicSel.disabled = false;
      monthSel.disabled = false;
      showLoader(false);
    }
  });

  goConfirm.addEventListener('click', () => {
    localStorage.setItem('pending_name',  localStorage.getItem('auth_name')  || '');
    localStorage.setItem('pending_phone', localStorage.getItem('auth_phone') || '');
    localStorage.setItem('pending_clinic', clinicSel.value);
    const clinicName = clinicSel.selectedOptions[0]?.text || '';
    localStorage.setItem('pending_clinic_label', clinicName);
    localStorage.setItem('pending_month', monthSel.value);
    localStorage.setItem('pending_time', timeSel.value);
    window.location.href = 'confirm.html';
  });

  // ====== تشغيل نافذة ساعات العمل ======
  const hoursModal = document.getElementById('hoursModal');
  const openHoursModal = document.getElementById('openHoursModal');
  const closeHoursModal = document.getElementById('closeHoursModal');

  openHoursModal.addEventListener('click', ()=> hoursModal.classList.add('show'));
  closeHoursModal.addEventListener('click', ()=> hoursModal.classList.remove('show'));
  hoursModal.addEventListener('click', (e)=>{ if(e.target===hoursModal) hoursModal.classList.remove('show'); });
</script>
</body>
</html>
