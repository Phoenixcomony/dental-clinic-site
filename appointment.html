<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حجز موعد | مجمع فينكس الطبي</title>
  <meta name="description" content="سجّل دخولك برقم الهوية/الإقامة والجوال مع تحقق واتساب، ثم احجز موعدك.">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --gold-main:#e2be6d;
      --gold-shadow:0 4px 32px 0 #e2be6d26, 0 1.5px 6px #ffdfa215;
      --gold-light:#fff8e6;
      --gold-gradient:linear-gradient(90deg,#e8ca7c 10%, #fff8e6 100%);
      --green-main:#2e7d32;
      --green-dark:#1b5e20;
      --green-shadow:0 6px 16px rgba(46,125,50,.35);
      --green-grad:linear-gradient(135deg,#2e7d32,#1b5e20);
    }
    body{ font-family:'Cairo', Tahoma, Arial, sans-serif; margin:0; min-height:100vh; display:flex; flex-direction:column; background:#fffdfa; }
    .wrap{ max-width:540px; margin:26px auto; background:#fff; border:1px solid #e8ca7c80; border-radius:18px; box-shadow:var(--gold-shadow); padding:18px; }
    .title{ display:flex; align-items:center; gap:10px; justify-content:center; font-weight:800; color:#a67c0e; margin:6px 0 14px; }
    label{ display:block; font-weight:700; color:#b18836; margin:.5rem 0 .3rem; }
    input, select, textarea{ width:100%; padding:12px 11px; border-radius:14px; border:1.4px solid #e2be6d99; background:#fffdfa; font-size:1rem; }
    textarea{ min-height:88px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ border:1.7px solid #e2be6d; background:#fff9e0; outline:none; }
    .btn{ width:100%; padding:13px 0; border:none; border-radius:16px; font-weight:800; background:var(--gold-gradient); color:#6b4b00; cursor:pointer; box-shadow:0 6px 16px #e2be6d33; transition:.2s ease; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:#7a6d4e; font-size:.95rem; text-align:center; min-height:22px; margin-top:8px; }
    .row{ display:flex; gap:8px; } .row > *{ flex:1; }
    footer{ margin-top:auto; text-align:center; padding:10px; color:#8c6d1c; font-weight:700; background:rgba(255,255,255,0.219); border-top:1.5px solid #eee; letter-spacing:.6px; box-shadow:0 -2px 12px #e2be6d54; }

    .blur-bg-appointment{ position: fixed; inset: 0; background: url('images/حجز الموعد.png') center/cover no-repeat; filter: blur(16px) brightness(0.97); opacity: 1; z-index: 0; pointer-events: none; }
    body > *:not(.blur-bg-appointment){ position: relative; z-index: 1; }

    header{ backdrop-filter: blur(6px); background: rgba(255,255,255,0.7); border-bottom: 1px solid #f1e4c5; box-shadow: 0 6px 24px #e2be6d26; position: sticky; top: 0; z-index: 5; }
    .container.header-flex{ display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:10px 16px; }
    .logo-container{ display:flex; align-items:center; gap:10px; }
    .logo-img{ height:46px; margin-left:9px; }
    header nav ul{ list-style:none; display:flex !important; flex-direction:row !important; align-items:center; gap:18px; margin:0; padding:0; background:transparent; flex-wrap:wrap; justify-content:center; }
    header nav ul li{ display:flex; align-items:center; margin:0; padding:0; }
    header nav ul li a{ color:#181818; text-decoration:none; padding:7px 14px; font-weight:700; border-radius:999px; font-size:1.05em; transition:.25s; background:transparent; display:inline-block; white-space:nowrap; }
    header nav ul li a.active, header nav ul li a:hover{ background-color:#fffbe7; color:#a8861c; box-shadow:0 2px 10px #e2be6d23; }

    .social-icons{ display:flex !important; align-items:center; gap:8px; margin-inline-start:8px; flex-wrap:nowrap; }
    .social-icons .social-icon{ font-size:1.1em; display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:50%; background:#fff3ce; color:#b89023; text-decoration:none; border:1.2px solid #f9e9c8; box-shadow:0 1px 6px #e2be6d26; transition:.2s; }
    .social-icons .social-icon:hover{ background:#fffbe7; color:#84610f; transform: translateY(-1px); }

    .screen-loader{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(255,255,255,0.55); backdrop-filter: blur(3px); z-index: 9999; transition: opacity .2s ease; }
    .screen-loader.show{ display:flex; }
    .spinner{ width: 70px; height: 70px; border-radius: 50%; border: 4px solid #e9d9ac; border-top-color: var(--gold-main); animation: spin 0.9s linear infinite; box-shadow: 0 8px 28px #e2be6d55; }
    @keyframes spin { to { transform: rotate(360deg);} }

    .btn-hours{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px; border:none; font-weight:800; cursor:pointer; background: var(--green-grad); color:#fff; box-shadow: var(--green-shadow); animation: breathe 1.8s ease-in-out infinite; }
    .btn-hours i{ font-size:1.05em; }
    @keyframes breathe{ 0%{ transform:scale(1); box-shadow:var(--green-shadow); } 50%{ transform:scale(1.045); box-shadow:0 12px 28px rgba(27,94,32,.55); } 100%{ transform:scale(1); box-shadow:var(--green-shadow); } }

    .btn-glass{ background:#cb9816; color:#010101; border:1.8px solid #ffffff; border-radius:999px; backdrop-filter:none; box-shadow:0 2px 10px rgba(5, 5, 5, 0.748); transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease; }
    .btn-glass:hover{ background:#cb9816; color:#ffffff; border-color:#111111; transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .btn-glass:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(0,0,0,.10); }

    .clinic-note{ display:none; margin:8px 0 0; color:#7a5d16; background:#fff9e8; border:1px dashed #e8ca7c; border-radius:12px; padding:10px 12px; font-weight:700; text-align:right; }

    .hours-table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
    .hours-table th,  .hours-table td{ border:1px solid #eee2bf; padding:10px; text-align:center; }
    .hours-table th{ background:#2e7d32; color:#fff; }

    .note-wrap{ display:none; margin-top:10px; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      border:1.5px solid #d4b05f; background:#fff; color:#7a5d16; padding:8px 12px; border-radius:999px;
      font-weight:800; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:.15s ease; user-select:none;
    }
    .chip small{ font-weight:700; opacity:.8; margin-inline-start:6px; }
    .chip:hover{ transform:translateY(-1px); }
    .chip.selected{ background:#1b1b1b; color:#fff; border-color:#111; }
    .chip.selected::after{ content:"✔"; margin-inline-start:6px; font-weight:900; }
  </style>
</head>
<body>

  <div class="blur-bg-appointment" aria-hidden="true"></div>

  <div id="screenLoader" class="screen-loader" aria-live="polite" aria-busy="true">
    <div class="spinner" role="status" aria-label="جاري التحميل"></div>
  </div>

  <header>
    <div class="container header-flex">
      <div class="logo-container">
        <img src="images/logo phoenix-Photoroom.png" alt="شعار مجمع فينكس الطبي" class="logo-img" loading="eager" decoding="async">
      </div>
      <nav aria-label="التنقل الرئيسي">
        <ul>
          <li><a href="index.html">الرئيسية</a></li>
          <li><a href="about.html">من نحن</a></li>
          <li><a href="services.html">الخدمات</a></li>
          <li><a href="appointment.html" class="active" aria-current="page">احجز موعد</a></li>
          <li><a href="contact.html">اتصل بنا</a></li>
          <li>
            <div class="social-icons">
              <a href="https://wa.me/966531422555" target="_blank" rel="noopener" title="واتساب" class="social-icon" aria-label="واتساب"><i class="fab fa-whatsapp"></i></a>
              <a href="https://www.instagram.com/phoenix.shq/" target="_blank" rel="noopener" title="إنستقرام" class="social-icon" aria-label="إنستقرام"><i class="fab fa-instagram"></i></a>
              <a href="https://www.snapchat.com/add/phoenix.shq?share_id=VOXDQhmXrWw&locale=ar-AE" target="_blank" rel="noopener" title="سناب شات" class="social-icon" aria-label="سناب شات"><i class="fab fa-snapchat-ghost"></i></a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <section id="loginSection" class="wrap">
    <div class="title"><i class="fa fa-user-check"></i> تسجيل الدخول</div>

    <label for="identity">رقم الهوية / الإقامة</label>
    <input id="identity" type="text" placeholder="مثال: 1234567890" inputmode="numeric" maxlength="10" autocomplete="off">

    <label for="mobile">رقم الجوال</label>
    <input id="mobile" type="text" placeholder="05xxxxxxxx" inputmode="numeric" maxlength="10" autocomplete="tel">

    <p style="color:#b00020; font-weight:bold; margin:12px 0; text-align:center;">
      🔔تنبيه: عيادة الليزر متاحة فقط للحجز في المجمع.
    </p>

    <div id="otpGroup" style="display:none;">
      <label for="otp">رمز التحقق (واتساب)</label>
      <input id="otp" type="text" placeholder="6 أرقام" inputmode="numeric" maxlength="6" autocomplete="one-time-code">
      <div class="row" style="margin-top:8px;">
        <button id="resendOtp" class="btn btn-glass" type="button" style="display:none;">إعادة الإرسال</button>
      </div>
      <div id="otpTimer" class="muted"></div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="sendOtp" class="btn btn-glass" type="button" style="display:none;">إرسال كود واتساب</button>
      <button id="loginBtn" class="btn btn-glass" type="button" disabled>تسجيل الدخول</button>
    </div>

    <div id="loginMsg" class="muted"></div>

    <p class="muted" style="margin-top:10px;">
      لا تملك ملفًا؟
      <button class="btn btn-glass" id="openNewFileBtn" type="button" style="padding:9px 12px;width:auto;">افتح ملف جديد</button>
    </p>
  </section>

  <section id="bookingSection" class="wrap" style="display:none;">
    <div class="title"><i class="fa-solid fa-calendar-check"></i> الحجز</div>

    <div style="display:flex; justify-content:center; margin:6px 0 12px;">
      <button id="toggleHours" type="button" class="btn-hours">
        <i class="fa-solid fa-clock"></i> عرض ساعات العمل
      </button>
    </div>

    <label for="clinic">اختر العيادة</label>
    <select id="clinic">
      <option value="">اختر العيادة</option>
      <option value="عيادة الاسنان 5 (NO.103)**الفترة الثانية">عيادة اسنان 5 الفترة المسائية(د.معاذ)</option>
      <option value="عيادة الاسنان 1 (NO.100)**الفترة الاولى">عيادة الاسنان 1 الفترة الصباحية(د.عبير)</option>
      <option value="عيادة الاسنان 1 (NO.100)**الفترة الثانية">عيادة الاسنان 1 الفترة المسائية(د.عبير)</option>
      <option value="عيادة الاسنان 2 (NO.101)**الفترة الاولى">عيادة الاسنان 2 الفترة الصباحية(د.ريان)</option>
      <option value="عيادة الاسنان 2 (NO.101)**الفترة الثانية">عيادة الاسنان 2 الفترة المسائية(د.ريان)</option>

      <option value="عيادة الاسنان 4 (NO.102)**الفترة الثانية">عيادة الاسنان 4 الفترة المسائية(د.رونالدو)</option>
      <option value="عيادة الجلدية والتجميل (NO.200)**الفترة الثانية">عيادة الجلدية والتجميل الفترة المسائية</option>
      <option value="تشقير وتنظيف البشرة**الفترة الثانية">عيادة التشقير و تنظيف البشرة الفترة المسائية</option>
      <option value="النساء و الولادة (NO.400)**الفترة الاولى">النساء و الولادة الفترة الصباحية</option>
      <option value="النساء و الولادة (NO.400)**الفترة الثانية">النساء و الولادة الفترة المسائية</option>
    </select>

    <div id="dermNote" class="clinic-note">
      تتضمن الخدمة تقشير وجه نصف ساعة + تشقير حواجب نصف ساعة + تنظيف البشرة نصف ساعة — المدة ساعة
    </div>

    <div id="skinServices" style="display:none;margin-top:8px;">
      <label>الخدمة المختارة</label>
      <div class="chips" id="chipsWrap">
        <button type="button" class="chip" data-key="brows"  data-min="30">تشقير حواجب <small>30د</small></button>
        <button type="button" class="chip" data-key="face"   data-min="30">تشقير وجه <small>30د</small></button>
        <button type="button" class="chip" data-key="clean"  data-min="60">تنظيف البشرة بدون ماسك <small>60د</small></button>
        <button type="button" class="chip" data-key="carbon" data-min="30">ليزر كربوني <small>30د</small></button>
        <button type="button" class="chip" data-key="mask"   data-min="75">تنظيف البشرة مع ماسك <small>75د</small></button>
      </div>
      <div id="svcHint" class="muted" style="text-align:right;margin-top:6px"></div>
    </div>

    <div id="noteWrap" class="note-wrap">
      <label for="note">نوع الخدمة / ملاحظة</label>
      <textarea id="note" placeholder="اكتب نوع الخدمة أو أي ملاحظة للموظف…"></textarea>
    </div>

    <label for="month" style="margin-top:10px;">اختر الشهر</label>
    <select id="month">
      <option value="">اختر الشهر</option>
      <option value="10">أكتوبر</option>
      <option value="11">نوفمبر</option>
      <option value="12">ديسمبر</option>
    </select>

    <button id="fetchBtn" class="btn btn-glass" style="margin-top:10px;">عرض المواعيد</button>

    <label for="time" style="margin-top:14px;">اختر الوقت</label>
    <select id="time" disabled>
      <option value="">يرجى البحث أولاً</option>
    </select>

    <button id="bookNowBtn" class="btn btn-glass" style="margin-top:12px;" disabled>تأكيد الحجز</button>

    <div id="bkMsg" class="muted"></div>
  </section>

  <section id="hoursSection" class="wrap" style="display:none;">
    <div class="title"><i class="fa-solid fa-clock"></i> ساعات العمل</div>

    <div style="display:flex; justify-content:center; margin:6px 0 12px;">
      <button id="toggleBooking" type="button" class="btn-hours">
        <i class="fa-solid fa-calendar-check"></i> عرض الحجز
      </button>
    </div>

    <div class="hours-table-wrap">
      <table class="hours-table">
        <thead>
          <tr>
            <th>القسم / الطبيب</th>
            <th>الأيام</th>
            <th>الفترة الصباحية</th>
            <th>الفترة المسائية</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>عيادة الأسنان 1 (د. عبير)</td><td>السبت - الخميس</td><td>9:00 ص – 12:00 م</td><td>4:00 م – 9:00 م</td></tr>
          <tr><td>عيادة الأسنان 2 (د. ريان)</td><td>السبت - الخميس</td><td>8:00 ص – 11:00 ص</td><td>4:00 م – 9:00 م</td></tr>
          <tr><td>عيادة الأسنان 3 (د. معاذ)</td><td>السبت - الخميس</td><td>12:00 م – 8:00 م</td><td>-</td></tr>
          <tr><td>عيادة الأسنان 4 (د. رونالدو)</td><td>السبت - الخميس</td><td>2:00 م – 10:00 م</td><td>-</td></tr>
          <tr><td>عيادة الجلدية والتجميل (د. ولاء)</td><td>الأحد - الخميس</td><td>-</td><td>3:30 م – 10:30 م</td></tr>
          <tr><td>التشقير وتنظيف البشرة (أخصائية هدى)</td><td>السبت - الخميس</td><td>-</td><td>2:00 م – 10:00 م</td></tr>
          <tr><td>عيادة الطب العام والطوارئ (د. هنادي)</td><td>السبت - الخميس</td><td>10:00 ص – 12:00 م</td><td>4:00 م – 10:00 م</td></tr>
          <tr><td>عيادة النساء والولادة (د. حسناء)</td><td>السبت - الخميس</td><td>10:00 ص – 12:00 م</td><td>4:00 م – 10:00 م</td></tr>
          <tr><td>عيادة الليزر (نساء) 1</td><td>السبت - الخميس</td><td>8:00 ص – 11:00 م</td><td>-</td></tr>
          <tr><td>عيادة الليزر (نساء) 2</td><td>السبت - الخميس</td><td>8:00 ص – 11:00 م</td><td>-</td></tr>
          <tr><td>عيادة الليزر (رجال)</td><td>السبت - الخميس</td><td>9:00 ص – 2:00 م</td><td></td></tr>
          <tr><td colspan="4" style="background:#fffbe9;font-weight:bold;color:#bb7d0a;">
            يوم الجمعة: طبيب أسنان مناوب، عيادات الليزر مفتوحة، التشقير وتنظيف البشرة حسب التوفر 2:00 م – 10:00 م.
          </td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <footer>جميع الحقوق محفوظة © مجمع فينكس الطبي 2025</footer>

<script>
  // ===== Helpers =====
  const isSaudi05 = (v)=> /^05\d{8}$/.test((v||'').replace(/\D/g,''));

  // ===== عناصر تسجيل الدخول =====
  const sendOtpBtn = document.getElementById('sendOtp');
  const resendOtpBtn = document.getElementById('resendOtp');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const identity = document.getElementById('identity');
  const mobile = document.getElementById('mobile');
  const otpInput = document.getElementById('otp');
  const otpGroup = document.getElementById('otpGroup');
  const otpTimerEl = document.getElementById('otpTimer');
  const screenLoader = document.getElementById('screenLoader');

  const showLoader = (on)=> {
    if(on){ screenLoader.classList.add('show'); document.body.style.pointerEvents='none'; }
    else { screenLoader.classList.remove('show'); document.body.style.pointerEvents='auto'; }
  };

  let otpCooldown = 0, otpTimer = null;
  function formatSecs(s){ return s + 'ث'; }

  function startOtpTimer(startFrom=60){
    otpCooldown = startFrom;
    resendOtpBtn.style.display = 'none';
    otpTimerEl.textContent = 'سيصل الكود خلال لحظات — يمكنك إعادة الإرسال بعد ' + formatSecs(otpCooldown);
    otpTimer && clearInterval(otpTimer);
    otpTimer = setInterval(()=>{
      otpCooldown--;
      if(otpCooldown<=0){
        clearInterval(otpTimer); otpTimer=null;
        otpTimerEl.textContent = 'انتهى الوقت. يمكنك إعادة الإرسال.';
        resendOtpBtn.style.display = '';
        resendOtpBtn.disabled = false;
      }else{
        otpTimerEl.textContent = 'يمكنك إعادة الإرسال بعد ' + formatSecs(otpCooldown);
      }
    },1000);
  }

  function updateLoginBtn(){
    const phoneOK = isSaudi05(mobile.value);
    sendOtpBtn.style.display = phoneOK && otpGroup.style.display==='none' ? '' : 'none';

    const idDigits = (identity.value||'').replace(/\D/g,'');
    const okId = idDigits.length >= 9;
    const okOtp  = /^\d{6}$/.test((otpInput.value||'').trim());
    const ok = okId && phoneOK && okOtp;

    loginBtn.disabled = !ok;
    loginMsg.textContent = ok ? '' : 'أدخل رقم الهوية/الإقامة، رقم 05xxxxxxxx، وكود 6 أرقام.';
  }

  ['input','change','keyup'].forEach(ev=>{
    identity.addEventListener(ev, updateLoginBtn);
    mobile.addEventListener(ev, updateLoginBtn);
    otpInput.addEventListener(ev, updateLoginBtn);
  });
  updateLoginBtn();

  async function sendOtp(phone){
    loginMsg.textContent = 'جاري إرسال الكود...';
    showLoader(true);
    try{
      const r = await fetch('http://127.0.0.1:3000/send-otp', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ phone })
      });
      const data = await r.json();
      if (data.success) {
        loginMsg.textContent = 'تم إرسال الكود على الواتساب';
        startOtpTimer(60);
        return true;
      } else {
        if (data.retryAfter){
          loginMsg.textContent = 'يرجى الانتظار ' + data.retryAfter + 'ث قبل إعادة الإرسال.';
          startOtpTimer(Number(data.retryAfter)||60);
        } else {
          loginMsg.textContent = data.message || 'تعذر الإرسال';
        }
        return false;
      }
    }catch{
      loginMsg.textContent = 'تعذر الاتصال بالخادم';
      return false;
    }finally{
      showLoader(false);
    }
  }

  sendOtpBtn.addEventListener('click', async ()=>{
    const phone = mobile.value.trim();
    if(!isSaudi05(phone)){ loginMsg.textContent = 'الرقم بصيغة 05xxxxxxxx'; return; }
    sendOtpBtn.style.display = 'none';
    otpGroup.style.display = '';
    otpInput.value = '';
    updateLoginBtn();
    await sendOtp(phone);
  });

  resendOtpBtn.addEventListener('click', async ()=>{
    const phone = mobile.value.trim();
    if(!isSaudi05(phone)) return;
    resendOtpBtn.disabled = true;
    const ok = await sendOtp(phone);
    if(!ok) resendOtpBtn.disabled = false;
  });

  document.getElementById('openNewFileBtn').addEventListener('click', ()=>{
    if ((identity.value||'').trim()) localStorage.setItem('auth_identity', (identity.value||'').trim());
    if (isSaudi05(mobile.value))     localStorage.setItem('auth_phone', mobile.value.trim());
    window.location.href = 'new-file.html';
  });

  // ===== تسجيل الدخول =====
  loginBtn.addEventListener('click', async ()=>{
    loginBtn.disabled = true; sendOtpBtn.disabled = true; resendOtpBtn.disabled = true;
    loginMsg.textContent = 'جارِ التحقق...';
    const payload = {
      identity: (identity.value||'').trim(),
      phone: (mobile.value||'').trim(),
      otp: (otpInput.value||'').trim()
    };
    showLoader(true);
    try{
      const r = await fetch('http://127.0.0.1:3000/api/login', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();

      if(!data.success){
        loginMsg.textContent = data.message || 'لا تملك ملفًا لدينا. انقر (افتح ملف جديد).';
        loginBtn.disabled = false; sendOtpBtn.disabled = false; resendOtpBtn.disabled = false;
        return;
      }

      localStorage.setItem('auth_identity', payload.identity);
      localStorage.setItem('auth_phone', payload.phone);
      localStorage.setItem('auth_fileId', data.fileId || '');

      if (data.hasIdentity === false) {
        loginMsg.textContent = 'نحتاج استكمال الهوية قبل الحجز...';
        setTimeout(()=>{ window.location.href = 'identity.html'; }, 500);
        return;
      }

      loginMsg.textContent = '';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('bookingSection').style.display = '';
      window.scrollTo({top:0, behavior:'smooth'});
      applyClinicFilter();
    }catch(e){
      loginMsg.textContent = 'تعذّر التحقق حاليًا. حاول لاحقًا.';
      loginBtn.disabled = false; sendOtpBtn.disabled = false; resendOtpBtn.disabled = false;
    }finally{
      showLoader(false);
    }
  });

  // ===== عناصر الحجز =====
  const fetchBtn   = document.getElementById('fetchBtn');
  const timeSel    = document.getElementById('time');
  const bookNowBtn = document.getElementById('bookNowBtn');
  const bkMsg      = document.getElementById('bkMsg');
  const clinicSel  = document.getElementById('clinic');
  const monthSel   = document.getElementById('month');
  const dermNote   = document.getElementById('dermNote');
  const noteWrap   = document.getElementById('noteWrap');
  const noteInput  = document.getElementById('note');

  const skinServices = document.getElementById('skinServices');
  const svcHint      = document.getElementById('svcHint');
  const chipsWrap    = document.getElementById('chipsWrap');

  function getSvcMinutes(){
    const sel = Array.from(chipsWrap.querySelectorAll('.chip.selected')).map(b=>+b.dataset.min);
    if (!sel.length) return 30;
    if (sel.includes(75)) return 75;
    if (sel.includes(60)) return 60;
    const sum30 = sel.filter(v=>v===30).reduce((a,b)=>a+b,0);
    return Math.max(sum30, 30);
  }
  function isSkinClinicValue(v){
    return /تشقير|تنظيف.?البشرة/i.test(String(v||''));
  }

  chipsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    const key = btn.dataset.key;

    if (key==='brows' || key==='face') {
      btn.classList.toggle('selected');
      const anyLong = chipsWrap.querySelector('.chip[data-key="clean"].selected, .chip[data-key="carbon"].selected, .chip[data-key="mask"].selected');
      if (anyLong) {
        chipsWrap.querySelectorAll('.chip[data-key="brows"], .chip[data-key="face"]').forEach(c=>c.classList.remove('selected'));
      }
    } else {
      chipsWrap.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
      btn.classList.add('selected');
    }

    const m = getSvcMinutes();
    svcHint.textContent = `المدة المطلوبة: ${m} دقيقة`;
  });

  function snapshotPendingForSuccess(){
    localStorage.setItem('pending_identity', localStorage.getItem('auth_identity') || '');
    localStorage.setItem('pending_phone',    localStorage.getItem('auth_phone')    || '');
    localStorage.setItem('pending_clinic', clinicSel.value);
    localStorage.setItem('pending_clinic_label', clinicSel.selectedOptions[0]?.text || clinicSel.value || '');
    localStorage.setItem('pending_month', monthSel.value);
    localStorage.setItem('pending_time', timeSel.value);
    localStorage.setItem('pending_note', (noteInput.value || '').trim());
  }

  function resetTimes(trigger=''){
    timeSel.innerHTML = `<option value="">يرجى الضغط على "عرض المواعيد" بعد التغيير</option>`;
    timeSel.disabled = true;
    bookNowBtn.disabled = true;
    bkMsg.textContent = trigger === 'clinic'
      ? 'تم تغيير العيادة — اعرض المواعيد من جديد.'
      : (trigger === 'month' ? 'تم تغيير الشهر — اعرض المواعيد من جديد.' : '');
  }

  clinicSel.addEventListener('change', ()=>{
    const v = clinicSel.value || '';
    const isSkin = isSkinClinicValue(v);
    dermNote.style.display   = isSkin ? 'block' : 'none';
    skinServices.style.display = isSkin ? 'block' : 'none';
    noteWrap.style.display   = v ? 'block' : 'none';
    resetTimes('clinic');
  });

  monthSel.addEventListener('change', ()=> resetTimes('month'));

  // اسم الشهر (نص) للاستخدام في /api/book-multi إن احتاجه الخادم
  function getSelectedMonthLabel(){
    return monthSel.selectedOptions[0]?.text?.trim() || monthSel.value || '';
  }

  fetchBtn.addEventListener('click', async () => {
    const clinic = clinicSel.value;
    const month  = monthSel.value;

    bkMsg.textContent = '';
    timeSel.disabled = true;
    bookNowBtn.disabled = true;
    timeSel.innerHTML = `<option>...جاري جلب الأوقات...</option>`;

    if (!clinic || !month) {
      timeSel.innerHTML = `<option value="">يرجى اختيار العيادة والشهر</option>`;
      return;
    }

    const needChainMin = isSkinClinicValue(clinic) ? getSvcMinutes() : 30;

    fetchBtn.disabled = true;
    clinicSel.disabled = true;
    monthSel.disabled = true;
    showLoader(true);

    try {
      const r = await fetch('/api/times', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ clinic, month, needChainMin })
      });
      const data = await r.json();

      if (data.times && data.times.length) {
        timeSel.innerHTML = data.times.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
        timeSel.disabled = false;
        bookNowBtn.disabled = false;
      } else {
        timeSel.innerHTML = `<option value="">لا توجد أوقات متاحة</option>`;
        bkMsg.textContent = 'لا توجد أوقات متاحة حالياً.';
      }
    } catch {
      timeSel.innerHTML = `<option value="">تعذر جلب الأوقات</option>`;
      bkMsg.textContent = 'تعذر جلب الأوقات. حاول لاحقاً.';
    } finally {
      fetchBtn.disabled = false;
      clinicSel.disabled = false;
      monthSel.disabled = false;
      showLoader(false);
    }
  });

  // ===== الحجز: يجرّب /api/book-multi ثم يسقط على /api/book =====
  bookNowBtn.addEventListener('click', async () => {
    const clinic = clinicSel.value;
    const monthVal  = monthSel.value;
    const monthLabel = getSelectedMonthLabel();
    const time   = timeSel.value;
    const identityVal = localStorage.getItem('auth_identity') || '';
    const phone  = localStorage.getItem('auth_phone') || '';
    const note   = (noteInput.value || '').trim();

    if (!clinic || !monthVal || !time || !identityVal || !phone) {
      bkMsg.textContent = 'الرجاء استكمال العيادة والشهر والوقت وتسجيل الدخول.';
      return;
    }

    const needChainMin = isSkinClinicValue(clinic) ? getSvcMinutes() : 30;
    const slotsCount = Math.max(1, Math.ceil(needChainMin / 15)); // كل خانة = 15 دقيقة

    snapshotPendingForSuccess();

    bookNowBtn.disabled = true;
    fetchBtn.disabled = true;
    clinicSel.disabled = true;
    monthSel.disabled = true;
    timeSel.disabled = true;
    showLoader(true);
    bkMsg.textContent = 'جاري تأكيد الحجز...';

    // جسم الطلب لـ /api/book-multi
    const multiBody = {
      identity: identityVal,
      name: '',                 // (اختياري) الخادم يعتمد على الهوية
      phone,
      clinic,
      month: monthLabel || monthVal,
      firstTimeValue: time,     // مثال: "2025-10-21*15:30"
      slotsCount,
      note
    };

    try {
      // 1) جرّب المتسلسل
      const resMulti = await fetch('/api/book-multi', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(multiBody)
      });

      // لو المسار غير موجود أو فشل واضح، ننتقل للاحتياطي
      let useFallback = false;
      if (!resMulti.ok) {
        useFallback = true;
      } else {
        const data = await resMulti.json().catch(()=>({}));
        if (!data || data.success === false) {
          useFallback = true;
        } else {
          // نجاح: أول خانة للمستخدم، والبوت يكمل الباقي في السيرفر
          localStorage.setItem('booking_result_msg', (data.message || 'تم تأكيد الحجز.'));
          window.location.href = 'success.html';
          return;
        }
      }

      // 2) احتياطي: /api/book-multi (حجز عدة خانات متتالية)
if (useFallback) {
 const monthText = monthSel.selectedOptions[0]?.text || monthVal;
const payload = {
  identity: identityVal,
  phone,
  clinic,
  month: monthText,
  firstTimeValue: time,
  slotsCount: Math.ceil(needChainMin / 15),
  note
};


  const res = await fetch('/api/book-multi', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  const msg = (data && data.msg) ? String(data.msg) : 'تم الحجز بنجاح';

  localStorage.setItem('booking_result_msg', msg);
  window.location.href = 'success.html';
}
} catch (e) {
  bkMsg.textContent = 'تعذر الاتصال بالخادم. حاول لاحقاً.';
  bookNowBtn.disabled = false;
  fetchBtn.disabled = false;
  clinicSel.disabled = false;
  monthSel.disabled = false;
  timeSel.disabled = false;
} finally {
  showLoader(false);
}
});


  // ===== تبديل العرض =====
  const bookingSection = document.getElementById('bookingSection');
  const hoursSection = document.getElementById('hoursSection');
  const toggleHoursBtn = document.getElementById('toggleHours');
  const toggleBookingBtn = document.getElementById('toggleBooking');

  function showHours(){
    bookingSection.style.display = 'none';
    hoursSection.style.display = '';
    window.scrollTo({top:0, behavior:'smooth'});
  }
  function showBooking(){
    hoursSection.style.display = 'none';
    bookingSection.style.display = '';
    window.scrollTo({top:0, behavior:'smooth'});
    applyClinicFilter();
  }

  toggleHoursBtn.addEventListener('click', showHours);
  toggleBookingBtn.addEventListener('click', showBooking);
</script>

<!-- فلترة العيادات المسائية للمقيم (هوية تبدأ بـ 2) -->
<script>
  const clinicSelect = document.getElementById("clinic");
  const identityEl   = document.getElementById("identity");

  function applyClinicFilter(){
    const id = (identityEl?.value || localStorage.getItem('auth_identity') || '').replace(/\D/g,'');
    const isIqama = id.startsWith('2');

    for (const option of clinicSelect.options) {
      const isEvening = option.value.includes("الفترة الثانية");
      option.hidden   = isIqama && isEvening;
      option.disabled = isIqama && isEvening;
    }
    if (isIqama && clinicSelect.value.includes("الفترة الثانية")) {
      clinicSelect.value = "";
    }
  }

  identityEl?.addEventListener('input', applyClinicFilter);
  document.addEventListener('DOMContentLoaded', applyClinicFilter);
</script>
</body>
</html>
