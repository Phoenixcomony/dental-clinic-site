<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تأكيد الحجز - مجمع فينكس الطبي</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#e2be6d; --gold2:#e8ca7c; --ink:#6b4b00; --muted:#7a6d4e;
      --bg:#faf6ee; --white:#fff;
      --shadow:0 10px 30px #e2be6d33, 0 2px 10px #e2be6d1c;
      --grad:linear-gradient(90deg,#ff7300 10%, #ff7b00 100%);
    }
    *{ box-sizing:border-box }
    body{ font-family:'Cairo', Arial, sans-serif; background:var(--bg); margin:0; min-height:100vh; display:flex; flex-direction:column; }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(28rem 28rem at -10% 120%, #ffe9b84d, transparent 60%),
        radial-gradient(32rem 32rem at 120% -10%, #fff3d94d, transparent 60%);
    }
    .confirm-main{
      width:95%; max-width:420px; margin:20px auto;
      background:var(--white); border-radius:16px; box-shadow:var(--shadow);
      padding:14px 12px; position:relative; overflow:hidden; border:1px solid #e8ca7c80;
    }
    .phoenix-logo{ width:64px; margin:4px auto 8px; display:block; }
    .title-confirm{
      font-size:1.1rem; color:#b89023; font-weight:800; text-align:center;
      background:#fdf4dd; border:1px solid #f1e4c5; border-radius:10px; padding:6px 0; margin:0 0 10px;
      box-shadow: inset 0 1px 8px #e2be6d14;
    }
    .confirm-label{ color:#a68e57; font-weight:700; text-align:right; margin:4px 0 2px; font-size:.9rem; }
    .confirm-input, .confirm-time, .confirm-textarea{
      width:100%; background:#f5f3ee; border:1.4px solid #eadcbc; border-radius:10px;
      padding:7px 8px; margin-bottom:8px; font-size:.9rem; color:#6f5a32; font-weight:600;
    }
    .confirm-time{ text-align:center; color:#7e733f; }
    .confirm-textarea{ resize:vertical; min-height:70px; }

    /* زر تأكيد الحجز مع نبض قوي */
    .btn-main{
      width:100%; padding:12px 0; font-size:1rem; border-radius:12px; border:none;
      background:var(--grad); color:#fff; font-weight:800; cursor:pointer;
      box-shadow:0 6px 14px #e2be6d66; letter-spacing:.3px;
      animation:pulse-strong 2s infinite;
    }
    .btn-main:disabled{ opacity:.7; cursor:not-allowed; animation:none; }

    @keyframes pulse-strong{
      0%   { transform:scale(1);   box-shadow:0 0 0 0 rgba(226,190,109,0.7); }
      50%  { transform:scale(1.08); box-shadow:0 0 20px 10px rgba(226,190,109,0.35); }
      100% { transform:scale(1);   box-shadow:0 0 0 0 rgba(226,190,109,0); }
    }

    .note{ text-align:center; min-height:20px; margin-top:6px; font-weight:600; font-size:.85rem; }
    footer{ background:transparent; color:#8c6d1c; text-align:center; padding:8px 0 12px; font-weight:bold; font-size:.85rem; }
    .screen-loader{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(255,255,255,.55); backdrop-filter:blur(3px); z-index:9999;
    }
    .screen-loader.show{ display:flex; }
    .spinner{
      width:50px; height:50px; border-radius:50%;
      border:3px solid #eadcb1; border-top-color:var(--gold); animation:spin .9s linear infinite;
      box-shadow:0 6px 20px #e2be6d55;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
  </style>
</head>
<body>

  <!-- شاشة انتظار -->
  <div id="screenLoader" class="screen-loader" aria-live="polite" aria-busy="true">
    <div class="spinner" role="status" aria-label="جارٍ تأكيد الحجز"></div>
  </div>

  <div class="confirm-main">
    <img src="images/logo phoenix-Photoroom.png" class="phoenix-logo" alt="شعار مجمع فينكس">
    <div class="title-confirm">تأكيد الحجز</div>

    <form id="confirmForm" autocomplete="off">
      <div class="confirm-label">الاسم الكامل:</div>
      <input type="text" id="name" class="confirm-input" readonly>

      <div class="confirm-label">رقم الجوال:</div>
      <input type="text" id="phone" class="confirm-input" readonly>

      <div class="confirm-label">العيادة:</div>
      <input type="text" id="clinic" class="confirm-input" readonly>

      <div class="confirm-label">الشهر:</div>
      <input type="text" id="month" class="confirm-input" readonly>

      <div class="confirm-label">الوقت:</div>
      <div id="timeDisplay" class="confirm-time"></div>
      <input type="hidden" id="time_raw" readonly>

      <div class="confirm-label">نوع الخدمة / ملاحظة (اختياري):</div>
      <textarea id="note" class="confirm-textarea" readonly placeholder="لا توجد ملاحظة"></textarea>

      <button type="button" id="confirmBtn" class="btn-main">تأكيد الحجز</button>
      <div id="message" class="note"></div>
    </form>
  </div>

  <footer>جميع الحقوق محفوظة © مجمع فينكس الطبي 2025</footer>

  <script>
    function formatTimeValue(raw) {
      try {
        if(!raw) return '';
        const [datePart, timePart=''] = raw.split('*');
        const [day, month, year] = datePart.split('-');
        const [h='0', m='0'] = timePart.split(':');
        const hour = parseInt(h,10), minute = parseInt(m,10);
        const ampm = hour < 12 ? 'صباحاً' : 'مساءً';
        let hour12 = hour % 12; if (hour12 === 0) hour12 = 12;
        return `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')} ${hour12}:${String(minute).padStart(2,'0')} ${ampm}`;
      } catch { return raw; }
    }

    const screenLoader = document.getElementById('screenLoader');
    const showLoader = (on)=>{ on ? screenLoader.classList.add('show') : screenLoader.classList.remove('show'); };

    window.onload = function() {
      const n  = localStorage.getItem('pending_name')   || '';
      const p  = localStorage.getItem('pending_phone')  || '';
      const cl = localStorage.getItem('pending_clinic_label') || '';
      const cm = localStorage.getItem('pending_month')  || '';
      const tm = localStorage.getItem('pending_time')   || '';
      const nt = localStorage.getItem('pending_note')   || '';

      document.getElementById('name').value   = n;
      document.getElementById('phone').value  = p;
      document.getElementById('clinic').value = cl;
      document.getElementById('month').value  = cm;
      document.getElementById('time_raw').value = tm;
      document.getElementById('timeDisplay').textContent = formatTimeValue(tm);
      document.getElementById('note').value = nt || '';

      const msgEl = document.getElementById('message');
      if (!n || !p || !cl || !cm || !tm) {
        msgEl.style.color = '#d51a1a';
        msgEl.textContent = 'بيانات الحجز غير مكتملة. الرجاء العودة واختيار العيادة والشهر والوقت.';
        document.getElementById('confirmBtn').disabled = true;
      }
    };

    document.getElementById('confirmBtn').onclick = async function() {
      const btn = this;
      const msgEl = document.getElementById('message');

      const name   = (document.getElementById('name').value || '').trim();
      const phone  = (document.getElementById('phone').value || '').trim();
      const clinic = localStorage.getItem('pending_clinic') || '';
      const month  = (document.getElementById('month').value || '').trim();
      const time   = (document.getElementById('time_raw').value || '').trim();
      const note   = (document.getElementById('note').value || '').trim();

      if (!name || !phone || !clinic || !month || !time) {
        msgEl.style.color = '#d51a1a';
        msgEl.textContent = 'بيانات الحجز غير مكتملة.';
        return;
      }

      btn.disabled = true;
      msgEl.style.color = '#b89023';
      msgEl.textContent = 'جاري تأكيد الحجز...';
      showLoader(true);

      const payload = { name, phone, clinic, month, time, note, key: Date.now().toString() };

      try {
        const res  = await fetch('/api/book', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        const msg  = (data && data.msg) ? String(data.msg) : '';

        localStorage.setItem('booking_result_msg', msg);

        if (/^✅/.test(msg)) {
          window.location.href = 'success.html';
        } else {
          msgEl.style.color = '#d51a1a';
          msgEl.textContent = msg || 'فشل الحجز.';
          btn.disabled = false;
        }
      } catch (e) {
        msgEl.style.color = '#d51a1a';
        msgEl.textContent = 'فشل الاتصال بالخادم.';
        btn.disabled = false;
      } finally {
        showLoader(false);
      }
    };
  </script>
</body>
</html>
