<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>المختبر | رفع النتائج</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{
    --blue:#1976d2;         /* أزرق أساسي */
    --blue-dark:#0d47a1;    /* أزرق غامق */
    --blue-soft:#e3f2fd;    /* خلفية فاتحة */
    --text:#0c1b2a;
    --muted:#5f6b76;
    --white:#ffffff;
    --shadow:0 10px 30px rgba(13,71,161,.15);
    --border:#cfe3fb;
    --chip:#eef6ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Cairo',Tahoma,Arial,sans-serif;background:var(--blue-soft);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
  header{position:sticky;top:0;background:linear-gradient(90deg,var(--blue),var(--blue-dark));color:var(--white);box-shadow:var(--shadow);z-index:10}
  .container{max-width:540px;margin:0 auto;padding:14px}
  h1{margin:0;display:flex;align-items:center;gap:10px;font-size:1.2rem}
  main.container{flex:1;width:100%}
  .card{background:var(--white);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin:16px 0;border:1px solid #d7e7fb}
  .muted{color:var(--muted);font-size:.95rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .full{grid-column:1/-1}
  button{cursor:pointer;border:none;border-radius:14px;font-weight:800}
  .btn{background:linear-gradient(90deg,var(--blue),var(--blue-dark));color:#fff;padding:12px 14px;box-shadow:0 8px 16px rgba(25,118,210,.25)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:var(--white);color:var(--blue);padding:11px 14px;border:1.6px solid var(--border)}
  input, select{width:100%;padding:12px 12px;border-radius:12px;border:1.6px solid var(--border);background:#f8fbff}
  input:focus, select:focus{outline:none;border-color:var(--blue)}
  .title{font-weight:800;color:var(--blue-dark);margin:0 0 10px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:#0d47a1;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700}
  .hide{display:none !important}
  footer{margin-top:auto;text-align:center;color:#2b3a45;font-weight:700;background:#f4f9ff;border-top:1px solid #e3eefb;padding:12px}
  /* شريط تقدم بسيط */
  .progress{height:8px;background:#e9f3ff;border-radius:999px;overflow:hidden}
  .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--blue),var(--blue-dark))}
  /* صندوق نتيجة */
  .result-ok{border:1px solid #c9efd8;background:#effaf3;color:#155d37;border-radius:12px;padding:12px}
  .result-err{border:1px solid #ffd1d1;background:#fff2f2;color:#8a1f1f;border-radius:12px;padding:12px}
</style>
</head>
<body>
<header>
  <div class="container"><h1><i class="fa-solid fa-vial"></i> المختبر (واجهة رفع نتائج)</h1></div>
</header>

<main class="container">

  <!-- نموذج الرفع -->
  <section class="card">
    <p class="title">رفع نتيجة (الفيتامينات)</p>

    <form id="labForm" action="/lab/upload" method="post" enctype="multipart/form-data" novalidate>
      <div class="grid2">
        <div class="full">
          <label for="analysis">نوع التحليل</label>
          <select name="analysis" id="analysis" required>
            <option value="vitamins" selected>الفيتامينات</option>
            <option value="chem" disabled>الكيمياويات (لاحقًا)</option>
          </select>
        </div>

        <div class="full">
          <label for="fileId">رقم ملف المريض (sid)</label>
          <input type="number" id="fileId" name="fileId" inputmode="numeric" placeholder="مثال: 12380" required />
        </div>

        <div class="full">
          <label for="pdf">ملف النتيجة (PDF فقط)</label>
          <input type="file" id="pdf" name="pdf" accept="application/pdf" required />
          <div class="muted">الحدّ الافتراضي للحجم: 10MB — يُمكن تغييره من إعدادات السيرفر.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="submitBtn" type="submit"><i class="fa-solid fa-paper-plane"></i> رفع وإرسال</button>
        <button class="btn-ghost" type="button" id="resetBtn"><i class="fa-solid fa-rotate-left"></i> إعادة تعيين</button>
      </div>

      <!-- شريط تقدم -->
      <div id="progWrap" class="hide" style="margin-top:14px">
        <div class="progress"><div id="progBar"></div></div>
        <div class="muted" id="progTxt" style="margin-top:6px">جارٍ التنفيذ…</div>
      </div>
    </form>
  </section>

  <!-- حالة العملية -->
  <section id="resultBox" class="card hide">
    <p class="title">نتيجة العملية</p>
    <div id="resultInner"></div>
  </section>

</main>

<footer>© المختبر — واجهة مبسّطة بنفس تصميم المخزن</footer>

<script>
(function(){
  const form = document.getElementById('labForm');
  const btn  = document.getElementById('submitBtn');
  const rst  = document.getElementById('resetBtn');
  const pdf  = document.getElementById('pdf');
  const fileId = document.getElementById('fileId');

  const progWrap = document.getElementById('progWrap');
  const progBar  = document.getElementById('progBar');
  const progTxt  = document.getElementById('progTxt');

  const resultBox   = document.getElementById('resultBox');
  const resultInner = document.getElementById('resultInner');

  function showProgress(on){
    progWrap.classList.toggle('hide', !on);
    if(on){ progBar.style.width = '20%'; progTxt.textContent = 'تحضير البيانات…'; }
  }
  function setProg(pct, text){
    progBar.style.width = pct + '%';
    if(text) progTxt.textContent = text;
  }
  function showResult(ok, html){
    resultBox.classList.remove('hide');
    resultInner.className = ok ? 'result-ok' : 'result-err';
    resultInner.innerHTML = html;
    window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
  }
  function resetUI(){
    form.reset();
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> رفع وإرسال';
    showProgress(false);
    resultBox.classList.add('hide');
    resultInner.innerHTML = '';
    progBar.style.width='0';
  }

  rst.addEventListener('click', resetUI);

  form.addEventListener('submit', async function(e){
    e.preventDefault();

    const f = pdf.files && pdf.files[0];
    if(!f){ alert('فضلاً اختر ملف PDF.'); return; }
    if(f.type !== 'application/pdf'){ alert('يُسمح فقط بملفات PDF.'); return; }
    const maxBytes = 10 * 1024 * 1024;
    if(f.size > maxBytes){ alert('حجم الملف يتجاوز 10MB.'); return; }
    if(!fileId.value.trim()){ alert('أدخل رقم ملف المريض (sid).'); fileId.focus(); return; }

    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جارٍ الرفع…';
    showProgress(true);

    try{
      setProg(35, 'رفع الملف…');
      const fd = new FormData(form);

      const res = await fetch('/lab/upload', { method:'POST', body: fd });
      setProg(65, 'معالجة الرد…');

      const data = await res.json().catch(()=>null);
      setProg(85, 'تقريبًا انتهينا…');

      if(!res.ok || !data){
        throw new Error('تعذّر التواصل مع الخادم.');
      }

      if(data.success){
        setProg(100, 'اكتملت العملية ✅');
        const phone = data.phoneLocal ? `<div class="pill"><i class="fa-solid fa-mobile-screen"></i> ${data.phoneLocal}</div>` : '';
        const link  = data.filePublicUrl ? `<a href="${data.filePublicUrl}" target="_blank" class="pill"><i class="fa-solid fa-file-pdf"></i> فتح الملف</a>` : '';
        const mode  = data.whatsappMode ? `<div class="muted">وضع الإرسال عبر واتساب: <b>${data.whatsappMode}</b></div>` : '';
        showResult(true, `
          <div style="display:flex;flex-direction:column;gap:10px">
            <div><b>تم رفع النتيجة داخل النظام وإرسالها عبر واتساب.</b></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">${phone} ${link}</div>
            ${mode}
          </div>
        `);
      }else{
        const stage = data.stage ? ` (المرحلة: ${data.stage})` : '';
        const phone = data.phoneLocal ? `<div class="muted">رقم الجوال المستخرج: ${data.phoneLocal}</div>` : '';
        const link  = data.filePublicUrl ? `<div class="muted"><a href="${data.filePublicUrl}" target="_blank">رابط الملف</a></div>` : '';
        showResult(false, `
          <div style="display:flex;flex-direction:column;gap:8px">
            <div><b>فشل التنفيذ${stage}.</b></div>
            <div>${(data.error || data.warning || 'حدث خطأ غير متوقع.')}</div>
            ${phone}${link}
          </div>
        `);
      }
    }catch(err){
      setProg(100);
      showResult(false, `<b>فشل التنفيذ.</b><br>${err.message || err}`);
    }finally{
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> رفع وإرسال';
    }
  });
})();
</script>
</body>
</html>
