<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فتح ملف جديد | مجمع فينكس الطبي</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --gold:#e2be6d;
      --gold-soft:#fff3d1;
      --ink:#5a4200;
      --bg:#f6f7f9;
      --card:#ffffffee;
      --border:#e2be6d55;
      --shadow:0 25px 60px rgba(15,23,42,.12);
      --radius:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Cairo',system-ui;
      background:
        radial-gradient(900px 400px at 90% -10%, #fff3d1, transparent 60%),
        radial-gradient(700px 500px at -10% 110%, #e2be6d33, transparent 60%),
        var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      color:#111;
    }

    /* Loader */
    .screen-loader{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.55);
      backdrop-filter:blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .screen-loader.show{display:flex;}
    .spinner{
      width:64px;height:64px;border-radius:50%;
      border:4px solid #eadcb1;
      border-top-color:var(--gold);
      animation:spin .9s linear infinite;
      box-shadow:0 12px 30px #e2be6d55;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Card */
    .card{
      width:100%;
      max-width:620px;
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:22px 22px 20px;
    }

    .header{
      text-align:center;
      margin-bottom:14px;
    }
    .logo{
      width:54px;height:54px;
      margin:0 auto 8px;
      border-radius:18px;
      background:linear-gradient(135deg,#e2be6d,#fff4d4);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#7a5708;
      box-shadow:0 12px 30px rgba(226,190,109,.35);
      font-size:1.4rem;
    }
    .header h1{
      margin:0;
      font-size:1.2rem;
      font-weight:900;
      color:#6b4b00;
    }
    .header p{
      margin:6px 0 0;
      color:#7a6d4e;
      font-weight:700;
      font-size:.9rem;
    }

    /* Steps */
    .steps{
      display:flex;
      gap:8px;
      justify-content:center;
      margin:14px 0 18px;
      flex-wrap:wrap;
    }
    .step{
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:.78rem;
      background:#fff8e6;
      border:1px solid var(--border);
      color:#7a5708;
      display:flex;
      align-items:center;
      gap:6px;
    }

    label{
      display:block;
      margin:10px 0 6px;
      font-weight:900;
      color:#6b4b00;
      font-size:.92rem;
    }

    .field{position:relative;}
    .field i{
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      color:#b89023;
      pointer-events:none;
    }

    input,select{
      width:100%;
      padding:12px 40px 12px 12px;
      border-radius:16px;
      border:1.6px solid var(--border);
      background:#fffdfa;
      font-size:.95rem;
      font-family:inherit;
      transition:.15s ease;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--gold);
      box-shadow:0 0 0 4px rgba(226,190,109,.25);
      background:#fff;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row>*{flex:1;}

    .btn{
      margin-top:14px;
      width:100%;
      padding:13px;
      border:none;
      border-radius:18px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      background:linear-gradient(135deg,#e2be6d,#fff4d4);
      color:#5b3e00;
      box-shadow:0 16px 40px rgba(226,190,109,.3);
      transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    .hint{
      text-align:center;
      margin-top:6px;
      font-size:.82rem;
      color:#7a6d4e;
      font-weight:700;
    }

    .msg{
      text-align:center;
      margin-top:10px;
      font-weight:800;
      min-height:22px;
    }
    .success{color:#1c8c36;}
    .error{color:#b00020;}

    @media(max-width:480px){
      .card{padding:18px;}
      .logo{width:48px;height:48px;}
    }
  </style>
</head>
<body>

<!-- Loader -->
<div id="screenLoader" class="screen-loader">
  <div class="spinner"></div>
</div>

<div class="card">
  <div class="header">
    <div class="logo"><i class="fa-solid fa-id-card-clip"></i></div>
    <h1>فتح ملف جديد</h1>
    <p>إنشاء ملف طبي في مجمع فينكس الطبي</p>
  </div>

  <div class="steps">
    <div class="step"><i class="fa-solid fa-user"></i> البيانات</div>
    <div class="step"><i class="fa-brands fa-whatsapp"></i> التحقق</div>
    <div class="step"><i class="fa-solid fa-floppy-disk"></i> الحفظ</div>
  </div>

  <label>الاسم الثلاثي</label>
  <div class="field">
    <input id="fullName" placeholder="محمد أحمد مصطفى">
    <i class="fa-solid fa-user"></i>
  </div>

  <label>رقم الهوية</label>
  <div class="field">
    <input id="idNumber" maxlength="10" placeholder="10 أرقام">
    <i class="fa-solid fa-id-card"></i>
  </div>

  <label>تاريخ الميلاد</label>
  <div class="row">
    <div class="field"><select id="day"></select><i class="fa-regular fa-calendar"></i></div>
    <div class="field"><select id="month"></select><i class="fa-regular fa-calendar-days"></i></div>
    <div class="field"><select id="year"></select><i class="fa-regular fa-calendar-check"></i></div>
  </div>

  <div class="row">
    <div>
      <label>الجنس</label>
      <div class="field">
        <select id="gender">
          <option value="">اختر</option>
          <option value="1">ذكر</option>
          <option value="2">أنثى</option>
        </select>
        <i class="fa-solid fa-venus-mars"></i>
      </div>
    </div>
    <div>
      <label>الجنسية</label>
      <div class="field">
        <select id="n" disabled>
          <option value="1" selected>Saudi</option>
          <option value="27">Other</option>
        </select>
        <i class="fa-solid fa-earth-asia"></i>
      </div>
    </div>
  </div>

  <label>رقم الجوال</label>
  <div class="field">
    <input id="phone" placeholder="05xxxxxxxx">
    <i class="fa-solid fa-phone"></i>
  </div>

  <button id="sendOtpBtn" class="btn">إرسال رمز التحقق</button>
  <div class="hint">سيصلك الرمز عبر واتساب</div>

  <label>رمز التحقق</label>
  <div class="field">
    <input id="otp" maxlength="6" placeholder="******">
    <i class="fa-solid fa-shield-check"></i>
  </div>

  <button id="saveBtn" class="btn">حفظ البيانات</button>
  <div id="msg" class="msg"></div>
</div>

<script>
  const $=id=>document.getElementById(id);
  const loader=$('screenLoader');
  const showLoader=b=>loader.classList.toggle('show',b);

  // DOB
  for(let i=1;i<=31;i++) day.innerHTML+=`<option>${i}</option>`;
  for(let i=1;i<=12;i++) month.innerHTML+=`<option>${i}</option>`;
  for(let i=new Date().getFullYear();i>=1900;i--) year.innerHTML+=`<option>${i}</option>`;

  // Nationality auto
  idNumber.addEventListener('input',()=>{
    n.value = idNumber.value.startsWith('1')?'1':'27';
  });

  // OTP
  sendOtpBtn.onclick=async()=>{
    if(!/^05\d{8}$/.test(phone.value)) return msg.textContent='رقم الجوال غير صحيح';
    showLoader(true);
    try{
      const r=await fetch('/send-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:phone.value})});
      const d=await r.json();
      msg.textContent=d.success?'تم إرسال الرمز':'فشل الإرسال';
    }catch{msg.textContent='خطأ اتصال';}
    showLoader(false);
  };

  // Save
  saveBtn.onclick=async()=>{
    showLoader(true);
    msg.textContent='جاري الحفظ...';
    try{
      const r=await fetch('/api/create-patient',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          fullName:fullName.value,
          nationalId:idNumber.value,
          day:day.value,month:month.value,year:year.value,
          gender:gender.value,nationalityValue:n.value,
          phone:phone.value,otp:otp.value
        })
      });
      const d=await r.json();
      if(d.success){
        msg.innerHTML='<span class="success">تم إنشاء الملف بنجاح</span>';
        setTimeout(()=>location.href='appointment.html',1200);
      }else msg.textContent=d.message||'فشل العملية';
    }catch{msg.textContent='خطأ اتصال';}
    showLoader(false);
  };
</script>

</body>
</html>
